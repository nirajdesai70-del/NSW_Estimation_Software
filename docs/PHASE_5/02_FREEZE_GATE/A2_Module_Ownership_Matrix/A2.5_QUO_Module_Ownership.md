# ✅ A2.5 — QUO Module Ownership Matrix

**Phase:** Phase-5  
**Category:** A — Freeze Gate Verification  
**Item:** A2.5  
**Status:** ✅ COMPLETED (Freeze-ready)  
**Date:** 2026-01-27  
**Purpose:** Lock table ownership, change authority, and responsibility boundaries for QUO (Quotation Workspace) tables including hierarchy (quotation → panel → bom → line items) and pricing snapshot fields.

⸻

## 1) Ownership Rule (Canonical)

- **Each table has one primary owner module.**
- **Owner module is accountable for:**
  - schema changes
  - validation rules
  - write-path APIs
  - data integrity guarantees
- **Non-owner modules may read via foreign keys, but must not introduce write logic without owner approval.**

⸻

## 2) QUO Tables — Ownership & Responsibilities

### 2.1 Quotation Workspace Header

| Table | Primary Owner | Responsibility Scope | Write Authority | Key Constraints / Notes |
|-------|---------------|---------------------|-----------------|-------------------------|
| `quotations` | QUO | Quotation header lifecycle, status, customer snapshot, quotation-wide commercial settings | QUO only | Tenant-scoped. Holds quotation-level discount (`discount_pct`) and tax selection (`tax_profile_id`, `tax_mode`) + tax snapshots |
| `quotation_revisions` (if exists) | QUO | Revision tracking for quotations | QUO only | Optional; if present, it is QUO-owned |

⸻

### 2.2 Panel / Sale Level

| Table | Primary Owner | Responsibility Scope | Write Authority | Key Constraints / Notes |
|-------|---------------|---------------------|-----------------|-------------------------|
| `quote_panels` | QUO | Panel/Sale workspace container | QUO only | Hierarchy root under quotation for BOM grouping and rollups |

⸻

### 2.3 BOM / Feeder Hierarchy Level

| Table | Primary Owner | Responsibility Scope | Write Authority | Key Constraints / Notes |
|-------|---------------|---------------------|-----------------|-------------------------|
| `quote_boms` | QUO | BOM workspace node (feeder/bom tree), origin tracking to MBOM | QUO only | Supports copy-never-link via `origin_master_bom_id` reference; stores instance tracking fields (verified in A4 later) |

⸻

### 2.4 BOM Line Items (Commercial Execution Lines)

| Table | Primary Owner | Responsibility Scope | Write Authority | Key Constraints / Notes |
|-------|---------------|---------------------|-----------------|-------------------------|
| `quote_bom_items` | QUO | Quotation line items: quantity, rate, discount_pct, rate_source, product binding, and line-level overrides | QUO only | Central commercial calculation table. Enforces G-02, G-05, G-06, G-07 via schema + compute |

**Important (Locked):**
- `quote_bom_items.product_id` is treated as L2 commercial identity binding today.
- CIM owns `products` master (transitional), but QUO owns the use of `product_id` in quotation workspace.

⸻

## 3) Locked Behavioral Contracts (QUO ↔ Other Modules)

### 3.1 QUO ↔ MBOM (Templates)
- QUO may reference `origin_master_bom_id` for traceability only
- QUO owns workspace edits and deviation tracking
- QUO must not mutate MBOM tables (copy-never-link)

### 3.2 QUO ↔ PRICING (Price Truth)
- QUO may consume `sku_prices` (via pricing lookup) but does not own price history
- QUO stores rate snapshots on lines (`rate`) when applied
- QUO must preserve manual and fixed pricing intent via `rate_source`

### 3.3 QUO ↔ CIM (Catalog & Taxonomy)
- QUO references CIM entities (category/make/series/product) but does not own them
- QUO may store denormalized columns for computation (e.g., `make_id`, `series_id`, `category_id`) for rule matching
- CIM remains the master owner of those entities

### 3.4 QUO ↔ TAX (Tax Profiles)
- QUO stores selection: `tax_profile_id`, `tax_mode`
- QUO stores computed snapshots: `taxable_base`, component rates, component amounts, `total_tax`, `grand_total`
- TAX module owns `tax_profiles`

### 3.5 QUO ↔ AUDIT
- QUO is a major producer of audit events:
  - `APPLY_RECALC`
  - `DISCOUNT_RULE_SET`/`UPDATE`/`DEACTIVATE`
  - `LINE_DISCOUNT_OVERRIDE_SET`
  - `QUOTATION_DISCOUNT_SET`
  - `OVERRIDE_RATE`
- QUO must not own audit storage

⸻

## 4) Explicit Non-Goals (Prevent Scope Drift)

**QUO module does not own:**
- catalog master tables (CIM)
- price history tables (PRICING)
- tax profile master tables (TAX)
- audit log tables (AUDIT)

**QUO owns only the workspace layer:** how a quotation is assembled, adjusted, priced, discounted, taxed, and snapshotted.

⸻

## 5) Enforcement Expectations (Freeze Gate)

**Must be true in implementation:**
- QUO endpoints/services are the only write path for quotations and quotation workspace tables
- QUO enforces Policy-1:
  - Preview = no DB overwrite
  - Apply-recalc = explicit action, role-restricted, audited
- QUO respects guardrails:
  - G-02 `product_id` constraints at L2
  - G-05 unresolved normalization behavior
  - G-06 fixed-no-discount enforcement
  - G-07 percentage-only discounts
  - G-08 reuse allowed (no uniqueness assumptions)

⸻

## 6) Evidence References (Where to Verify)

- **QUO endpoints:**
  - `backend/app/api/v1/endpoints/quotation.py`
  - `backend/app/api/v1/endpoints/discounts.py`
  - `backend/app/api/v1/endpoints/tax.py`
- **Guardrails documents:**
  - `docs/PHASE_5/02_FREEZE_GATE/A1_Validation_Guardrails/*`
- **Schema canon migrations:**
  - `backend/alembic/versions/20260104_110400_create_schema_canon_v1_0_l1_l2_quo_pricing.py`
- **Apply/Preview logic:**
  - `_compute_quote_pricing()`, `pricing/preview`, `pricing/apply-recalc`

⸻

## 7) Freeze Gate Compliance

**Freeze Gate Checklist Item:** A2.5 — QUO table ownership  
**Status:** ✅ VERIFIED  
**Approval:** ✅ APPROVED

⸻

## Next Task

➡️ **A2.6** — PRICING module ownership (`price_lists`, `sku_prices`, import batches, pipeline tables)

