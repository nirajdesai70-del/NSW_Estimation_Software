# ✅ A2.7 — AUDIT Module Ownership Matrix

**Phase:** Phase-5  
**Category:** A — Freeze Gate Verification  
**Item:** A2.7  
**Status:** ✅ COMPLETED (Freeze-ready)  
**Date:** 2026-01-27  
**Purpose:** Lock ownership, write authority, and structural boundaries for system-wide audit storage and audit event semantics.

⸻

## 1) Ownership Rule (Canonical)

- **Each table has one primary owner module.**
- **Owner module is accountable for:**
  - schema changes
  - validation rules
  - write-path APIs (or write helpers)
  - integrity guarantees (immutability, traceability)
- **Non-owner modules may write audit events only via the AUDIT interface (AuditLogger or AUDIT API), not by direct table manipulation unless explicitly allowed.**

⸻

## 2) AUDIT Tables — Ownership & Responsibilities

| Table | Primary Owner | Responsibility Scope | Write Authority | Key Constraints / Notes |
|-------|---------------|---------------------|-----------------|-------------------------|
| `audit_logs` (canonical name) | AUDIT | System-wide audit event storage | AUDIT-owned storage; write by any module via AuditLogger | Must support `tenant_id` + actor + resource + before/after JSON. Append-only behavior expected |
| `audit_log` (if legacy name exists) | AUDIT | Legacy alias/transition only | AUDIT | Do not create competing storage. Prefer canonical `audit_logs` |
| `bom_change_logs` (if exists) | AUDIT | Optional specialized audit for BOM diffs | AUDIT | If present, remains AUDIT-owned; QUO produces events, AUDIT stores |

**If only `audit_logs` exists today:** treat that as canonical.  
**If both exist:** mark one as deprecated and route all writes to canonical.

⸻

## 3) Locked Audit Event Contract (System-wide)

### 3.1 Minimum Required Fields (Locked)

**Every audit record must include (direct fields or JSONB):**
- `tenant_id`
- `user_id` (actor)
- `action` (event type string)
- `resource_type` (e.g., quotation, quote_bom_item, discount_rule)
- `resource_id`
- `old_values` (JSON)
- `new_values` (JSON)
- `metadata` (JSON)
- `created_at` timestamp

**Evidence Reference (implementation):**
- `backend/app/audit/logger.py` — `AuditLogger.log_event()`

⸻

### 3.2 Allowed Writers (Cross-module)
- AUTH / CIM / MBOM / QUO / PRICING / TAX are audit producers
- AUDIT is audit store owner

**Locked Rule:**
- No module owns the `audit_logs` schema except AUDIT.
- Modules can emit events but cannot redefine audit storage or schema.

⸻

## 4) Behavioral Contracts (AUDIT ↔ Other Modules)

### 4.1 AUDIT ↔ QUO (Most active producer)

**QUO produces events like:**
- `APPLY_RECALC`
- `QUOTATION_DISCOUNT_SET`
- `LINE_DISCOUNT_OVERRIDE_SET`
- discount rule events (`DISCOUNT_RULE_SET`/`UPDATE`/`DEACTIVATE`)
- rate override events (`OVERRIDE_RATE`)

**QUO must not store audits in QUO tables (only snapshots and workspace data).**

### 4.2 AUDIT ↔ PRICING

**PRICING produces events for:**
- imports/batches/approvals (if implemented)
- pricing rule updates (if any)

**Append-only pricing history is separate from audit history; audit captures "who changed what".**

### 4.3 AUDIT ↔ AUTH

**AUTH produces events for:**
- user/role lifecycle (if endpoints exist)
- role assignments (`user_roles`)

⸻

## 5) Explicit Non-Goals (Prevent Scope Drift)

**AUDIT module does not own:**
- business calculations (pricing/discount/tax)
- quote workspace persistence (`quotations`/`quote_bom_items`)
- catalog identity or price truth

**AUDIT exists solely to provide:**
- traceability
- accountability
- forensic reconstruction of business actions

⸻

## 6) Enforcement Expectations (Freeze Gate)

**Must be true in implementation:**
- `AuditLogger.log_event()` is the standard write interface
- Audit writes do not cause partial commits by themselves (caller owns transaction)
- Audit records include `tenant_id` (no hardcoded `tenant_id`)
- Audit is append-only in behavior (no update/delete in normal operations)
- Any audit schema change requires AUDIT owner approval

**Evidence:**
- `backend/app/audit/logger.py` (tenant_id required + no internal commit)
- Apply-Recalc and discount endpoints (use AuditLogger)

⸻

## 7) Evidence References (Where to Verify)

- **Audit logger implementation:**
  - `backend/app/audit/logger.py`
- **Audit usage examples:**
  - `backend/app/api/v1/endpoints/quotation.py` (APPLY_RECALC)
  - `backend/app/api/v1/endpoints/discounts.py` (discount events)
  - `backend/app/api/v1/endpoints/tax.py` (TAX_PROFILE_SET)
- **Schema canon:**
  - `backend/alembic/versions/*schema_canon*` (CREATE TABLE audit_logs)

⸻

## 8) Freeze Gate Compliance

**Freeze Gate Checklist Item:** A2.7 — AUDIT table ownership  
**Status:** ✅ VERIFIED  
**Approval:** ✅ APPROVED

⸻

## Next Task

➡️ **A2.8** — AI module ownership (AI reservation tables, AI call logs, future scope boundary)

