# A1.7 — Document Guardrail G-06: FIXED_NO_DISCOUNT Forces Discount = 0

**Phase:** Phase-5  
**Category:** A — Freeze Gate Verification  
**Item:** A1.7  
**Status:** ✅ COMPLETED (Freeze-ready)  
**Date:** 2026-01-27  
**Purpose:** Ensure that fixed, non-discountable pricing cannot be altered by any discount mechanism.

---

## 1️⃣ Guardrail Definition

### G-06: FIXED_NO_DISCOUNT Forces Discount = 0

**Intent:**
Certain prices are contractually or commercially fixed and must never be discounted. The system must enforce this invariant regardless of rule configuration.

**Rule:**
When a quotation BOM line has `rate_source = 'FIXED_NO_DISCOUNT'`:
- `discount_pct` must be 0
- No discount rule (LINE / MAKE_SERIES / CATEGORY / SITE) may alter the effective rate
- Quotation-level discounts must not apply to that line

**Business Rationale:**
- Protects non-negotiable pricing (AMC, statutory items, pass-through costs)
- Prevents accidental erosion via bulk or site discounts
- Ensures contractual compliance and audit defensibility
- Makes pricing outcomes deterministic and explainable

---

## 2️⃣ Enforcement Layers

### A) Schema Layer (Primary Enforcement)

**What is enforced:**
- When `rate_source = 'FIXED_NO_DISCOUNT'`, `discount_pct = 0`
- Prevents persistence of illegal combinations

**Evidence:**
- **Source:** `backend/alembic/versions/20260104_110400_create_schema_canon_v1_0_l1_l2_quo_pricing.py`
- **Table:** `quote_bom_items`
- **Constraint Name:** `chk_quote_bom_item_rate_source` (singular "item")
- **How to locate:** search for `FIXED_NO_DISCOUNT` AND `discount_pct` in migration file, or search for constraint name `chk_quote_bom_item_rate_source`

**Constraint Logic (conceptual):**
```sql
CHECK (
  (rate_source = 'FIXED_NO_DISCOUNT' AND discount_pct = 0) OR
  (rate_source != 'FIXED_NO_DISCOUNT')
)
```

**Failure Mode:**
- Hard reject at DB layer (CHECK constraint violation)

---

### B) Compute Layer (Secondary Enforcement)

**What is enforced:**
- Discount engine applies no discount when rate source is fixed
- Net rate equals base rate regardless of discount rules

**Evidence:**
- **File:** `backend/app/estimation/discount_engine.py`
  - Item discount application logic
- **File:** `backend/app/api/v1/endpoints/quotation.py`
  - `_compute_quote_pricing()` does not override fixed rates

**Behavior:**
- Even if discount rules exist, effective discount = 0
- Prevents runtime discount leakage

---

### C) Rule Resolver Layer (Precedence Protection)

**What is enforced:**
- Discount resolver precedence does not override fixed pricing
- FIXED_NO_DISCOUNT implicitly supersedes all discount scopes

**Evidence:**
- **File:** `backend/app/estimation/discount_resolver.py`
  - Concept: Rate source classification precedes discount application

---

### D) Audit Layer (Traceability)

**Expectation:**
- Any attempt to alter fixed pricing is either:
  - Blocked (schema)
  - Or logged if part of correction workflow

**Evidence:**
- **File:** `backend/app/audit/logger.py`
  - Discount or apply-recalc audit captures final applied values

---

## 3️⃣ Canonical Outcomes

**When `rate_source = 'FIXED_NO_DISCOUNT'`:**

| Field | Required State |
|-------|----------------|
| `rate` | Fixed base rate |
| `discount_pct` | 0 (forced) |
| `net_rate` | Equals rate |
| discount rules | Ignored |
| quotation discount | Does not apply |
| audit | Final values traceable |

### Quotation-Scoped Fixed Price Clarification

FIXED_NO_DISCOUNT applies to both:
1. **Canonical fixed prices** (e.g., AMC, statutory, catalog fixed items)
2. **Project / quotation-specific negotiated fixed prices**

For project-specific cases:
- The fixed rate is stored directly on `quote_bom_items.rate`
- `rate_source = 'FIXED_NO_DISCOUNT'`
- `discount_pct = 0` (forced)
- `override_reason` should indicate "Project/quotation fixed rate"
- SKU / price list is **NOT** modified

This ensures:
- Fixed pricing remains quotation-scoped
- Future quotations continue to use catalog pricing
- No misuse of discounts for fixed price replacement
- Supplier rate revisions for specific projects do not affect master pricing

---

## 4️⃣ Failure Modes

### A) Discount rule attempts to apply
- **Trigger:** SITE / CATEGORY / LINE rule exists
- **Outcome:** Discount ignored (compute) or blocked (schema)

### B) Manual edit attempts to set discount
- **Trigger:** User sets `discount_pct > 0`
- **Outcome:** DB constraint violation (hard fail)

---

## 5️⃣ Relationship to Other Guardrails
- **G-04:** RateSource consistency (origin must match applied behavior)
- **G-05:** UNRESOLVED normalizes values (safety baseline)
- **G-07:** Preview ≠ Apply (Policy-1)
- **G-03:** IsPriceMissing normalization (financial safety)

**Together ensure:**
- Fixed pricing is inviolable
- Discounts only apply where explicitly allowed

---

## 6️⃣ Freeze Gate Compliance

**Freeze Gate Checklist Item:** G-06 — FIXED_NO_DISCOUNT forces Discount = 0

**Status:** ✅ **VERIFIED**
- ✅ Schema constraint exists
- ✅ Compute path respects fixed pricing
- ✅ Discount precedence cannot override
- ✅ Deterministic and auditable

**Freeze Gate Approval:** ✅ **APPROVED**

---

## 7️⃣ Data Dictionary Integration

**This guardrail will be added to:**
- `docs/PHASE_5/03_DATA_DICTIONARY/NSW_DATA_DICTIONARY_v1.0.md`
- Section: Canonical Validation Guardrails
- Reference: G-06

---

## References

- `backend/alembic/versions/20260104_110400_create_schema_canon_v1_0_l1_l2_quo_pricing.py`
- `backend/app/estimation/discount_engine.py`
- `backend/app/estimation/discount_resolver.py`
- `backend/app/api/v1/endpoints/quotation.py`
- `backend/app/audit/logger.py`

---

**Documentation Completed:** 2026-01-27  
**Next Task:** A1.8 — Guardrail G-07: All Discounts Are Percentage-Based

---

## 9️⃣ Tier-1 Deep-Dive (Optional)

For governance-grade micro-specification with explicit non-goals, failure semantics, audit event schemas, and future extension guardrails, see:

- **A1.7b — G-06 FIXED_NO_DISCOUNT (Tier-1 Micro-Spec)**  
  *(This is an additive enhancement document. A1.7 remains the primary reference.)*

