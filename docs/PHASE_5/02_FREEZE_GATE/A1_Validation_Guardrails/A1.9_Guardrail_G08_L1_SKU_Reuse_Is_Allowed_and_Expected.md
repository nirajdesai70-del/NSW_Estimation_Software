# A1.9 — Document Guardrail G-08: L1–SKU Reuse Is Allowed and Expected

**Phase:** Phase-5  
**Category:** A — Freeze Gate Verification  
**Item:** A1.9  
**Status:** ✅ COMPLETED (Freeze-ready)  
**Date:** 2026-01-27  
**Purpose:** Ensure catalog SKU reuse is not treated as a data anomaly and remains a first-class behavior across quotations and BOMs.

---

## 1️⃣ Guardrail Definition

### G-08: L1–SKU Reuse Is Allowed and Expected

**Intent:**
Prevent incorrect "uniqueness assumptions" that would break estimation workflows, inflate catalog complexity, and cause unnecessary duplication.

**Rule:**
A given SKU (L2 commercial identity) may be reused across:
- multiple quotations
- multiple panels / feeders / BOMs
- multiple lines within the same quotation (if quantities / contexts require)

This is not an error condition.

**Note:** In current schema, L2 commercial identity is represented by `product_id` on `quote_bom_items` (acts as SKU reference). This guardrail applies to that reference.

**Business Rationale:**
- Same SKU is often used repeatedly (e.g., standard contactors, breakers, relays)
- Reuse improves catalog integrity and pricing consistency
- Prevents SKU explosion and duplicate master data
- Supports many-to-one mapping: multiple intent lines can map to the same SKU

---

## 2️⃣ Enforcement Layers

### A) Schema Layer (Primary "Non-Enforcement": no uniqueness constraints)

**What is enforced:**
- The schema must not enforce uniqueness of `product_id` usage on quote lines.
- There must be no unique constraint such as:
  - `(quotation_id, product_id)` unique
  - `(tenant_id, product_id)` unique on line usage tables

**Evidence:**
- **Table:** `quote_bom_items`
- **Columns:** `product_id`, `quotation_id`
- **Source:** `backend/alembic/versions/20260104_110400_create_schema_canon_v1_0_l1_l2_quo_pricing.py`
- **How to locate:** search for UNIQUE constraints on `quote_bom_items` involving `product_id`
  - (expected: none)

**Failure Mode:**
- If a uniqueness constraint were added, it would violate this guardrail (schema defect).

---

### B) Compute Layer (Deterministic aggregation supports reuse)

**What is enforced:**
- Totals logic aggregates all lines independently:
  - each line contributes `qty × net_rate`
  - reuse does not collapse lines automatically

**Evidence:**
- **File:** `backend/app/api/v1/endpoints/quotation.py`
  - `_compute_quote_pricing()` sums line amounts; does not deduplicate by SKU
- **File:** `backend/app/estimation/discount_engine.py`
  - line amount computation uses qty and net_rate per line

**Failure Mode:**
- Wrong aggregation logic (dedupe-by-sku) would be a compute bug.

---

### C) Pricing Resolver Layer (SKU rate lookup supports multi-line usage)

**What is enforced:**
- SKU rate lookup is independent per line (same SKU may appear multiple times)
- No "single-use" assumption exists in pricing resolution

**Evidence:**
- **File:** `backend/app/estimation/pricing_resolver.py`
  - `resolve_line_rate()` resolves per line
  - `snapshot_line_rate()` persists per line
- **Tests:** `backend/tests/phase5/test_pricing_resolver.py`

**Failure Mode:**
- Any caching that changes behavior must remain idempotent and not collapse lines.

---

### D) Audit Layer (Traceability per line)

**What is enforced:**
- Audits are written at the line level (`resource_id = line_id`)
- Reuse does not prevent traceability

**Evidence:**
- **File:** `backend/app/audit/logger.py`
  - Audit patterns already used for overrides and apply-recalc

---

## 3️⃣ Canonical Outcomes (What must always be true)

### Outcome A — Same SKU used across many quotations
- Allowed and expected
- No uniqueness checks should block it

### Outcome B — Same SKU appears multiple times in same quotation
- Allowed when needed (e.g., separate feeders, separate cost heads, separate contexts)
- Aggregation still correct (sum of all lines)

### Outcome C — Many-to-one mapping is allowed conceptually
- Multiple intent lines can map to one SKU
- The system must not force SKU uniqueness as a proxy for "correctness"

---

## 4️⃣ Failure Modes

### A) Incorrect uniqueness enforcement
- **Trigger:** a unique constraint or validation rule forbids reuse
- **Outcome:** blocks normal estimation workflows (defect)

### B) Incorrect aggregation (dedupe-by-sku)
- **Trigger:** compute logic collapses identical SKUs into one line unintentionally
- **Outcome:** wrong totals (defect)

---

## 5️⃣ Relationship to Other Guardrails
- **G-04:** RateSource consistency ensures each reused SKU line remains traceable
- **G-07:** Percentage discounts apply deterministically, even across repeated SKUs
- **G-07 Policy-1:** Preview/apply remains deterministic even with repeated SKUs
- **G-05:** UNRESOLVED normalization prevents partial reuse from corrupting totals

---

## 6️⃣ Freeze Gate Compliance

**Freeze Gate Checklist Item:** G-08 — L1–SKU reuse is allowed and expected

**Status:** ✅ **VERIFIED**
- ✅ No uniqueness constraints block reuse
- ✅ Compute path aggregates per-line without deduping
- ✅ Pricing resolution is line-scoped
- ✅ Audit remains line-scoped

**Freeze Gate Approval:** ✅ **APPROVED**

---

## 7️⃣ Data Dictionary Integration

**This guardrail will be added to:**
- `docs/PHASE_5/03_DATA_DICTIONARY/NSW_DATA_DICTIONARY_v1.0.md`
- Section: Canonical Validation Guardrails
- Reference: G-08

---

## References

- `backend/alembic/versions/20260104_110400_create_schema_canon_v1_0_l1_l2_quo_pricing.py` (quote_bom_items schema)
- `backend/app/api/v1/endpoints/quotation.py` (_compute_quote_pricing)
- `backend/app/estimation/discount_engine.py`
- `backend/app/estimation/pricing_resolver.py`
- `backend/tests/phase5/test_pricing_resolver.py`
- `backend/app/audit/logger.py`

---

**Documentation Completed:** 2026-01-27  
**Next Task:** A1.10 — Add "Canonical Validation Guardrails" section to Data Dictionary

---

## 9️⃣ Tier-1 Deep-Dive (Optional)

For governance-grade micro-specification with explicit non-goals, failure semantics, audit expectations, and future extension guardrails, see:

- **A1.9b — G-08 L1–SKU Reuse (Tier-1 Micro-Spec)**  
  *(This is an additive enhancement document. A1.9 remains the primary reference.)*

