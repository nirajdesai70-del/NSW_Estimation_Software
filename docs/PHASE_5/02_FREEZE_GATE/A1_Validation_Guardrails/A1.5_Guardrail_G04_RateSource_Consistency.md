# A1.5 — Document Guardrail G-04: RateSource Consistency

**Phase:** Phase-5  
**Category:** A — Freeze Gate Verification  
**Item:** A1.5  
**Status:** ✅ COMPLETED (Freeze-ready)  
**Date:** 2026-01-27  
**Purpose:** Ensure every quotation line has a deterministic, auditable rate origin so totals are traceable and reproducible.

---

## 1️⃣ Guardrail Definition

### G-04: RateSource Consistency

**Intent:**
A quotation line's rate must always be explainable and reproducible. The system must never allow "ambiguous" or "mixed" rate origins.

**Rule:**
For every quotation BOM line:
- A rate must be derived from exactly one source category:
  - **PRICELIST** (system-derived)
  - **MANUAL** (authorized override)
- The persisted rate_source must match the applied rate used for calculations.
- Manual override requires authorization and reason (links to G-03 override governance).

**Business Rationale:**
- Prevents silent pricing changes
- Enables audit and dispute resolution
- Ensures preview/apply determinism (Policy-1)
- Keeps pricing refresh safe (manual overrides remain distinct)

---

## 2️⃣ Enforcement Layers

### A) Validator Layer (Primary Enforcement for Manual)

**What is enforced:**
- If rate_source == MANUAL:
  - user must be Reviewer/Approver
  - override_rate must be > 0
  - override_reason must be present

**Evidence:**
- **File:** `backend/app/validators/override_rules.py`
- **Class/Method:** `OverrideRulesValidator.validate_override_request()`
- **Tests:** `backend/tests/phase5/test_pricing_resolver.py` (role, reason, rate validations)

**Failure Mode:**
- Hard reject (validation error / HTTP 403/400 depending on endpoint integration)

---

### B) Resolver / Persistence Layer (Primary Enforcement for Snapshot Consistency)

**What is enforced:**
- On persistence, rate_source is written alongside the applied rate
- RateSource is mapped correctly to DB enum values (DB correctness)
- Deterministic rounding/quantization is applied before persistence (prevents drift)

**Evidence:**
- **File:** `backend/app/estimation/pricing_resolver.py`
  - `resolve_line_rate()` (deterministic resolution)
  - `snapshot_line_rate()` (persistence of rate_source + rate)
- **File:** `backend/app/estimation/rate_source_map.py`
  - Internal ↔ DB mapping (e.g., MANUAL → DB MANUAL_WITH_DISCOUNT if used)
- **File:** `backend/app/estimation/decimal_norm.py`
  - `qrate()` quantization (rate determinism)
- **Tests:** `backend/tests/phase5/test_pricing_resolver.py`

**Failure Mode:**
- Hard reject if required fields missing (e.g., sku_id for PRICELIST)
- Hard reject if override invalid (validator)

---

### C) Schema Layer (Supporting Enforcement)

**What is enforced:**
- Rate fields exist and are typed to prevent invalid storage
- Override columns exist to support traceability (override_rate, override_reason, overridden_by, overridden_at)
- Precision is aligned (DECIMAL storage supports deterministic values)
- Rate precision consistency enforced via DECIMAL + qrate quantization

**Evidence:**
- **Migrations:**
  - `backend/alembic/versions/20260104_120000_add_phase5_override_columns.py`
  - `backend/alembic/versions/20260104_130100_fix_override_rate_precision.py`

**Failure Mode:**
- DB constraint/type enforcement (hard fail on invalid values)

---

### D) Audit Layer (Traceability Enforcement)

**What is enforced:**
- Override operations and recalculation actions are logged
- rate_source and applied rate changes are auditable

**Evidence:**
- **File:** `backend/app/audit/logger.py` (AuditLogger.log_event())
- **Audit Events:** OVERRIDE_RATE, APPLY_RECALC (and any rate set events used)
- **Tests:** `backend/tests/phase5/test_apply_recalc.py` (apply audit), pricing resolver tests

**Failure Mode:**
- Audit omission is treated as defect (process enforcement)

---

## 3️⃣ Canonical Outcomes (What must always be true)

### Outcome A — PRICELIST
- rate_source = PRICELIST
- rate = effective SKU rate for quote context
- override_rate is NULL (or unused)
- override_reason is NULL (or unused)

### Outcome B — MANUAL
- rate_source = MANUAL (internally) and mapped correctly for DB storage
- rate = override_rate
- override_rate is NOT NULL
- override_reason is NOT NULL
- overridden_by, overridden_at tracked

---

## 4️⃣ Current Runtime Behavior

**Observed behavior in Phase-5 implementation:**
- Manual overrides cannot occur silently (role + reason enforced)
- Rate persistence writes both the applied rate and the rate source
- Audit records capture override events
- Apply-Recalc uses shared compute logic and keeps snapshots deterministic

---

## 5️⃣ Failure Modes

### A) Manual override attempted by unauthorized role
- **Trigger:** Operator tries MANUAL
- **Outcome:** Hard reject (permission denied)

### B) Manual override missing reason or invalid rate
- **Trigger:** Missing reason or override_rate <= 0
- **Outcome:** Hard reject (validation failure)

### C) PRICELIST missing sku_id / no price available
- **Trigger:** Pricelist resolution cannot produce a rate
- **Outcome:** Must not silently substitute
- **Expected:** System should treat it as unresolved pricing (ties to G-03 IsPriceMissing normalization)

---

## 6️⃣ Relationship to Other Guardrails
- **Manual override governance:** override_rules.py (role+reason)
- **Price missing normalization:** Guardrail G-03 (A1.4)
- **G-07 (Policy-1):** preview vs apply must stay deterministic
- **Audit rules (G-05):** backend audit trail provides traceability

---

## 7️⃣ Freeze Gate Compliance

**Freeze Gate Checklist Item:** 4.4 - G4: RateSource consistency

**Status:** ✅ **VERIFIED**
- ✅ Validator enforcement exists (manual override governance)
- ✅ Persistence captures rate_source + rate
- ✅ Audit captures override actions
- ✅ DB columns support traceability and precision

**Freeze Gate Approval:** ✅ **APPROVED**

---

## 8️⃣ Data Dictionary Integration

**This guardrail will be added to:**
- `docs/PHASE_5/03_DATA_DICTIONARY/NSW_DATA_DICTIONARY_v1.0.md`
- Section: Canonical Validation Guardrails
- Reference: G-04

---

## References

- `backend/app/validators/override_rules.py`
- `backend/app/estimation/pricing_resolver.py`
- `backend/app/estimation/rate_source_map.py`
- `backend/app/estimation/decimal_norm.py`
- `backend/app/audit/logger.py`
- `backend/tests/phase5/test_pricing_resolver.py`
- `backend/alembic/versions/20260104_120000_add_phase5_override_columns.py`
- `backend/alembic/versions/20260104_130100_fix_override_rate_precision.py`

---

**Documentation Completed:** 2026-01-27  
**Next Task:** A1.6 — Document Guardrail G-05: UNRESOLVED Normalizes Values

---

## 9️⃣ Tier-1 Deep-Dive (Optional)

For governance-grade micro-specification with explicit non-goals, failure semantics, audit event schemas, and future extension guardrails, see:

- **A1.5b — G-04 RateSource Consistency (Tier-1 Micro-Spec)**  
  *(This is an additive enhancement document. A1.5 remains the primary reference.)*
