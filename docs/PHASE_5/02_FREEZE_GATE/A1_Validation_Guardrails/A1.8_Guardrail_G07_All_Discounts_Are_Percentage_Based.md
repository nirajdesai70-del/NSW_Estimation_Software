# A1.8 — Document Guardrail G-07: All Discounts Are Percentage-Based

**Phase:** Phase-5  
**Category:** A — Freeze Gate Verification  
**Item:** A1.8  
**Status:** ✅ COMPLETED (Freeze-ready)  
**Date:** 2026-01-27  
**Purpose:** Ensure discounting is uniform, audit-friendly, and mathematically deterministic across all quotation flows.

---

## 1️⃣ Guardrail Definition

### G-07: All Discounts Are Percentage-Based

**Intent:**
Prevent ambiguity and inconsistent calculations by enforcing one universal discount representation across the platform.

**Rule:**
All discount inputs and stored discount values must be expressed only as:
- percentage (0 to 100, inclusive)

Absolute (amount-based) discounts such as ₹250 off or -₹1000 are not allowed in Phase-5.

**Business Rationale:**
- Percentage discounts scale correctly with quantity changes and rate refresh
- Eliminates dual-mode discount confusion (amount vs percent)
- Improves audit clarity and reduces dispute risk
- Keeps calculations deterministic and stable across preview/apply

---

## 2️⃣ Enforcement Layers

### A) Schema Layer (Primary Enforcement of Data Type)

**What is enforced:**
- Discount fields are stored as numeric percentages (not amount deltas)
- Column types reflect percentage semantics

**Evidence:**
- **Discount rules table:** `discount_rules.discount_pct` is a percentage column
  - **Migration:** `backend/alembic/versions/20260104_130000_create_discount_rules.py`
  - **Column:** `discount_pct DECIMAL(5,2)`
  - **Constraint:** `discount_pct` must be between 0 and 100
  - **How to locate:** search for `discount_pct` AND `discount_rules` in migration files
- **Quotation line discounts:** `quote_bom_items.discount_pct` is a percentage column
  - **Schema canon migration:** `backend/alembic/versions/20260104_110400_create_schema_canon_v1_0_l1_l2_quo_pricing.py`
  - **Column:** `discount_pct` (percentage)
  - **Constraint:** `chk_quote_bom_items_discount_pct` (0..100 range)
  - **How to locate:** search for `discount_pct` on `quote_bom_items` table
- **Quotation-level discount:** `quotations.discount_pct` is a percentage column
  - **Migration:** `backend/alembic/versions/20260127_090000_add_quotation_discount_pct.py`
  - **Column:** `discount_pct DECIMAL(5,2)` with check constraint
  - **How to locate:** search for `quotations.discount_pct` or constraint name in migration files

**Failure Mode:**
- Hard reject on invalid range (DB check constraint violation)
- No schema exists for absolute discounts → they cannot be stored

---

### B) API / Validation Layer (Primary Enforcement of Input Form)

**What is enforced:**
- API accepts only `discount_pct` (not absolute discount)
- Input bounds enforced (0–100)

**Evidence:**
- **Discount endpoints schemas:** `DiscountRuleUpsertRequest.discount_pct` (0..100)
  - **File:** `backend/app/api/v1/schemas/discount.py`
- **Line override schema:** `LineDiscountOverrideRequest.discount_pct` (0..100)
  - **File:** `backend/app/api/v1/schemas/discount.py`
- **Quotation-level discount schema:** `QuotationDiscountSetRequest.discount_pct` (0..100)
  - **File:** `backend/app/api/v1/schemas/quotation_discount.py`

**Failure Mode:**
- Hard reject (HTTP 422 / schema validation error) if out of range
- Absolute discount fields are not present, so absolute discounts cannot be passed

---

### C) Compute Layer (Deterministic Math & Quantization)

**What is enforced:**
- Discounts are interpreted strictly as percentage
- Percentage is quantized to 2 decimal places
- Rates/amounts quantized to 4 decimal places for determinism

**Evidence:**
- **File:** `backend/app/estimation/discount_engine.py`
  - `validate_pct()` ensures range 0..100
  - percentage quantization to 2dp
  - deterministic calculation path
- **File:** `backend/app/estimation/decimal_norm.py`
  - `qrate()` ensures 4dp numeric determinism

**Failure Mode:**
- Hard reject for invalid pct values (ValueError in compute layer)

---

### D) Audit Layer (Traceability)

**What is enforced:**
- Audit captures discount changes in percent form
- No absolute discount events exist in audit because they are not representable

**Evidence:**
- **Discount audit events:**
  - `DISCOUNT_RULE_SET`, `DISCOUNT_RULE_UPDATE`, `LINE_DISCOUNT_OVERRIDE_SET`
  - **File:** `backend/app/audit/logger.py`

---

## 3️⃣ Canonical Outcomes (What must always be true)

### A) Rule discounts
- Stored as `discount_pct` only
- Applies via precedence (LINE > MAKE_SERIES > CATEGORY > SITE)

### B) Line override discounts
- Stored as `discount_pct` + `discount_source='LINE'`
- Still percent-based

### C) Quotation-level discount
- Stored as `quotations.discount_pct`
- Applied after line discounts, before tax

---

## 4️⃣ Failure Modes

### A) Attempt to apply absolute discount
- **Trigger:** user/system tries to provide an amount-based discount
- **Outcome:** Not representable in schema or API → rejected by design

### B) Invalid percent (>100 or <0)
- **Trigger:** `discount_pct` outside 0..100
- **Outcome:** rejected by schema/API/compute validators

---

## 5️⃣ Relationship to Other Guardrails
- **G-06:** FIXED_NO_DISCOUNT forces discount=0
- **G-04:** RateSource consistency ensures deterministic pricing inputs
- **G-07 (this):** keeps discount semantics uniform
- **G-07 Policy-1:** preview/apply determinism relies on stable math inputs

---

## 6️⃣ Freeze Gate Compliance

**Freeze Gate Checklist Item:** G-07 — All discounts are percentage-based

**Status:** ✅ **VERIFIED**
- ✅ Schema enforces percentage columns
- ✅ API schemas accept only percent fields
- ✅ Compute layer validates percent range and quantization
- ✅ Audit records percent-based values only

**Freeze Gate Approval:** ✅ **APPROVED**

---

## 7️⃣ Data Dictionary Integration

**This guardrail will be added to:**
- `docs/PHASE_5/03_DATA_DICTIONARY/NSW_DATA_DICTIONARY_v1.0.md`
- Section: Canonical Validation Guardrails
- Reference: G-07

---

## References

- `backend/alembic/versions/20260104_130000_create_discount_rules.py` (discount_rules.discount_pct + check constraint)
- `backend/alembic/versions/20260127_090000_add_quotation_discount_pct.py` (quotations.discount_pct + check constraint)
- `backend/app/api/v1/schemas/discount.py` (DiscountRuleUpsertRequest, LineDiscountOverrideRequest)
- `backend/app/api/v1/schemas/quotation_discount.py` (QuotationDiscountSetRequest)
- `backend/app/estimation/discount_engine.py` (validate_pct + pct quantization)
- `backend/app/estimation/decimal_norm.py` (qrate quantization)
- `backend/app/audit/logger.py` (audit logging)

---

**Documentation Completed:** 2026-01-27  
**Next Task:** A1.9 — Guardrail G-08: L1-SKU reuse is allowed and expected

