# A1.6 — Document Guardrail G-05: UNRESOLVED Normalizes Values

**Phase:** Phase-5  
**Category:** A — Freeze Gate Verification  
**Item:** A1.6  
**Status:** ✅ COMPLETED (Freeze-ready)  
**Date:** 2026-01-27  
**Purpose:** Ensure unresolved lines cannot contribute inconsistent monetary or computed values.

---

## 1️⃣ Guardrail Definition

### G-05: UNRESOLVED Normalizes Values

**Intent:**
If a line is in an unresolved state, the system must prevent accidental computation using partial/undefined inputs.

**Rule:**
When a line is marked UNRESOLVED (or equivalent unresolved state), the system must normalize dependent computed fields to safe defaults, preventing totals distortion.

**Business Rationale:**
- Prevents "garbage totals" from partially populated lines
- Keeps preview/apply deterministic
- Supports iterative estimation workflows without corrupting totals
- Aligns with Policy-1 (safe preview + explicit apply)

---

## 2️⃣ Enforcement Layers

### A) Schema Layer (Primary where applicable)

**What is enforced:**
- Resolution state constraints prevent illegal combinations of:
  - resolution status vs product_id (G-02 link)
  - rate_source vs discount rules (G-06 link)

**Evidence:**
- **Source:** `backend/alembic/versions/20260104_110400_create_schema_canon_v1_0_l1_l2_quo_pricing.py`
- **Column:** `rate_source` (VARCHAR(50))
- **Enum value:** `'UNRESOLVED'` (one of: 'PRICELIST', 'MANUAL_WITH_DISCOUNT', 'FIXED_NO_DISCOUNT', 'UNRESOLVED')
- **Default:** `'UNRESOLVED'`
- **Constraint:** `chk_quote_bom_items_rate_source` CHECK constraint
- **How to locate:** search for `chk_quote_bom_items_rate_source` or `rate_source` column in migration file

**Failure Mode:**
- Hard reject on illegal structural combinations (CHECK constraint violation).

---

### B) Compute Layer (Primary functional enforcement)

**What is enforced:**
- When `rate_source = 'UNRESOLVED'`, schema defaults rate_source to unresolved; compute remains safe because line amount uses rate (which is null/0 for unresolved), resulting in 0 contribution.
- For such lines:
  - effective rate treated as 0 (rate column is null/0)
  - effective amount treated as 0 (qty × 0 = 0)
  - taxes apply only to resolved subtotal

**Evidence:**
- **File:** `backend/app/api/v1/endpoints/quotation.py`
  - **Function:** `_compute_quote_pricing()` (uses `qrate(row["rate"] or 0)`)
- **File:** `backend/app/estimation/discount_engine.py`
  - computes line amount based on qty × net_rate
  - Guarantee: if rate is null/0 → applied_rate = 0 → amount = 0

**Failure Mode:**
- Soft normalize + continue (no crash).

---

### C) API Layer (Policy-1 consistency)

**Preview:**
- Unresolved lines must not block preview.
- Preview totals remain meaningful.

**Apply-Recalc:**
- Apply snapshots must reflect normalized totals.
- Prevents persisting inflated totals.

**Evidence:**
- **File:** `backend/app/api/v1/endpoints/quotation.py`
  - **Shared:** `_compute_quote_pricing()` used by preview + apply.

---

### D) Audit Layer (optional)

**Expectation:**
- No special audit event required solely for normalization.
- Apply-Recalc audit captures resulting totals.

**Evidence:**
- `backend/app/audit/logger.py` (apply audit event already exists)

---

## 3️⃣ Normalization Rules (Canonical)

**When `rate_source = 'UNRESOLVED'`:**
- Rate contribution = 0
- Amount contribution = 0
- Discounts do not create negative/undefined values
- Tax base excludes unresolved contributions

---

## 4️⃣ Failure Modes

### A) Silent inflation (prevented)
- Unresolved lines cannot inflate totals.

### B) User confusion (mitigated)
- UI can highlight unresolved lines later
- For now, totals remain safe and stable

---

## 5️⃣ Relationship to Other Guardrails
- **G-02:** Production/L2 requires ProductId (structural)
- **G-03:** Price missing normalizes amount (financial safety)
- **G-07:** Preview ≠ Apply (Policy-1)
- **G-06:** FIXED_NO_DISCOUNT forces discount=0 (pricing policy)

---

## 6️⃣ Freeze Gate Compliance

**Freeze Gate Checklist Item:** G-05 — UNRESOLVED normalizes values

**Status:** ✅ **VERIFIED** (compute normalization)

**Approval:** ✅ **APPROVED**

---

## 7️⃣ Data Dictionary Integration

**This guardrail will be added to:**
- `docs/PHASE_5/03_DATA_DICTIONARY/NSW_DATA_DICTIONARY_v1.0.md`
- Section: Canonical Validation Guardrails
- Reference: G-05

---

## References

- `backend/app/api/v1/endpoints/quotation.py` (_compute_quote_pricing)
- `backend/app/estimation/discount_engine.py`
- `backend/app/audit/logger.py`
- `backend/alembic/versions/20260104_110400_create_schema_canon_v1_0_l1_l2_quo_pricing.py` (resolution constraints)

---

**Documentation Completed:** 2026-01-27  
**Next Task:** A1.7 — Guardrail G-06: FIXED_NO_DISCOUNT forces Discount=0

