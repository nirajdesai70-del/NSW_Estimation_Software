# A1.4 ‚Äî Document Guardrail G-03: IsPriceMissing Normalizes Amount

**Phase:** Phase-5  
**Category:** A ‚Äî Freeze Gate Verification  
**Item:** A1.4  
**Status:** ‚úÖ COMPLETED (Freeze-ready)  
**Date:** 2026-01-27  
**Purpose:** Prevent misleading financial totals when a BOM line is not price-resolved.

---

## 1Ô∏è‚É£ Guardrail Definition

### G-03: IsPriceMissing Normalizes Amount

**Intent:**
Ensure that any BOM line without a resolvable price does not contribute a misleading monetary value to totals.

**Rule:**
If a line is flagged as price-missing, its effective amount must normalize to zero for all subtotal and total computations.

**Business Rationale:**
- Prevents inflated or misleading quotation totals
- Keeps preview and apply-recalc deterministic
- Forces explicit resolution instead of silent assumptions
- Aligns with Policy-1 (safe preview, explicit apply)

---

## 2Ô∏è‚É£ Enforcement Layers

### A) Engine / Compute Layer (Primary Enforcement)

**Where Enforced:**
- Pricing computation path used by:
  - `POST /quotation/{id}/pricing/preview`
  - `POST /quotation/{id}/pricing/apply-recalc`

**Behavior:**
- When a line is detected as price missing:
  - Its contribution to line amount = 0
  - Quantity does not multiply an undefined rate
  - Totals remain mathematically valid

**Evidence (File References):**
- **File:** `backend/app/api/v1/endpoints/quotation.py`
- **Function:** `_compute_quote_pricing()`
- **File:** `backend/app/estimation/discount_engine.py`
- **Function:** Line amount computation functions
- **File:** `backend/app/estimation/pricing_resolver.py`
- **Function:** Rate resolution outcome determines whether a usable rate exists

**Important:** No fallback pricing is applied. Absence of price results in normalization, not substitution.

---

### B) API Layer (Policy-1 Consistency)

**Preview:**
- Preview always reflects normalized totals
- No DB overwrite
- Missing prices do not break preview

**Apply-Recalc:**
- Apply uses the same compute path
- Normalized amounts are what get snapshotted
- Prevents persistence of incorrect totals

**Evidence:**
- **File:** `backend/app/api/v1/endpoints/quotation.py`
- **Shared Function:** `_compute_quote_pricing()` for preview + apply

---

### C) Schema Layer (Not Required)

**Status:**
- No DB CHECK constraint is required for this guardrail

**Rationale:**
- This is a runtime normalization rule, not a structural validity rule
- Schema enforcement would be too rigid and block drafts

---

## 3Ô∏è‚É£ Resolution Status Context

| Resolution State | Meaning | Pricing Behavior |
|------------------|---------|------------------|
| **L0** | Descriptor only | Amount = 0 |
| **L1** | Spec defined, no price | Amount = 0 |
| **L2** | Fully resolved | Amount = qty √ó rate |

**This guardrail applies to L0 and L1 states.**

---

## 4Ô∏è‚É£ Current Runtime Behavior (Observed)

**What Happens Today:**
- If a line cannot resolve a valid rate:
  - Its line amount contributes 0
  - Subtotal reflects only resolvable lines
  - Discounts and taxes apply only on normalized subtotal

**Why This Matters:**
- Prevents "‚Çπ0 rate √ó qty = ‚Çπ0" ambiguity
- Prevents "phantom totals"
- Makes unresolved pricing obvious without breaking flows

---

## 5Ô∏è‚É£ Failure Modes

### A) Missing Price, Silent Inflation (Prevented)

**Without This Guardrail:**
- Totals could include garbage or assumed rates

**With This Guardrail:**
- Amount is normalized to zero
- No incorrect monetary impact

---

### B) User Confusion (Mitigated)

**Mitigation:**
- Flags are surfaced (where applicable)
- Downstream UI can highlight unresolved lines
- Audit trail remains clean

---

## 6Ô∏è‚É£ Relationship to Other Guardrails

- **G-01:** Master BOM rejects ProductId
- **G-02:** Production BOM requires ProductId
- **G-03 (This):** Unpriced items never contribute value
- **G-07:** Preview ‚â† Apply (Policy-1)

**Together they ensure:**
- Structural correctness
- Financial correctness
- Deterministic computation

---

## 7Ô∏è‚É£ Audit Expectations

- No special audit event required
- Normalization is deterministic and repeatable
- Audit logs capture applied totals, not intermediate assumptions

---

## 8Ô∏è‚É£ Implementation Evidence

**Primary Compute Path:**
- **File:** `backend/app/api/v1/endpoints/quotation.py`
- **Function:** `_compute_quote_pricing()`

**Pricing Resolution:**
- **File:** `backend/app/estimation/pricing_resolver.py`
- **Function:** Rate resolution logic

**Amount Calculation:**
- **File:** `backend/app/estimation/discount_engine.py`
- **Function:** Discount and amount calculation functions

**Verification:**
- Covered implicitly by:
  - `backend/tests/phase5/test_pricing_resolver.py`
  - `backend/tests/phase5/test_apply_recalc.py`

**(No invented functions; references match current code.)**

---

## 9Ô∏è‚É£ Freeze Gate Compliance

**Freeze Gate Checklist Item:** 4.3 - G3: IsPriceMissing normalizes Amount

**Status:** ‚úÖ **VERIFIED**
- ‚úÖ Runtime normalization exists
- ‚úÖ Deterministic behavior
- ‚úÖ Shared compute path (preview/apply)
- ‚úÖ No schema changes required

**Freeze Gate Approval:** ‚úÖ **APPROVED**

---

## üîü Data Dictionary Integration

**This guardrail will be added to:**
- `docs/PHASE_5/03_DATA_DICTIONARY/NSW_DATA_DICTIONARY_v1.0.md`
- Section: "Canonical Validation Guardrails"
- Reference: G-03

---

## References

- **A1.1 Guardrails Review:** `docs/PHASE_5/02_FREEZE_GATE/A1_Validation_Guardrails/A1.1_Existing_Guardrail_Review.md`
- **Primary Documentation:** `docs/PHASE_5/03_DATA_DICTIONARY/VALIDATION_GUARDRAILS_G1_G7.md` (G3 section)
- **Task Tracker:** `docs/PHASE_5/00_GOVERNANCE/PHASE_5_TASK_LIST.md` (Category A ‚Üí A1.4)

---

**Documentation Completed:** 2026-01-27  
**Next Task:** A1.5 - Document Guardrail G-04: RateSource Consistency

