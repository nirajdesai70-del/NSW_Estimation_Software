# G-06 ‚Äî FIXED_NO_DISCOUNT Forces Discount = 0 (Tier-1 Micro-Spec)

> **‚ö†Ô∏è IMPORTANT: This is an ADDITIVE enhancement to A1.7, not a replacement.**  
> The primary reference remains `A1.7_Guardrail_G06_FIXED_NO_DISCOUNT_Forces_Discount_Zero.md`.  
> This micro-spec provides governance-grade depth for audit, future-proofing, and developer clarity.  
> Both documents work together: A1.7 for freeze-gate verification, A1.7b for deep implementation guidance.

**Phase:** Phase-5  
**Category:** A ‚Äî Validation Guardrails (Tier-1)  
**Rule ID:** G-06  
**Status:** üîí LOCKED  
**Date:** 2026-01-27  
**Template:** Tier-1 Micro-Spec (CANONICAL)  
**Primary Reference:** A1.7_Guardrail_G06_FIXED_NO_DISCOUNT_Forces_Discount_Zero.md (Freeze-Gate Verified)

‚∏ª

## 1Ô∏è‚É£ Rule Identifier

- **Rule ID:** G-06
- **Category:** Validation / Runtime Control / Financial Governance
- **Phase Introduced:** Phase-5
- **Risk Class:** üî¥ Tier-1 (Financial / Audit / Legal)

‚∏ª

## 2Ô∏è‚É£ Intent (What This Rule Protects)

**Protection:** G-06 protects quotation-specific fixed pricing commitments from being altered‚Äîintentionally or accidentally‚Äîby discounts, repricing, or price-list refresh operations.

It ensures that when a supplier or commercial team agrees to a fixed rate for a specific quotation/project, that rate:
- Remains immune to discounts (both line-level and quotation-level)
- Remains immune to apply-recalc price refresh
- Does not contaminate the catalog price list
- Remains auditable and defensible
- Supports the critical use case: "Supplier gives project/quotation-specific fixed price, but catalog price list should remain for future quotes"

**If Violated:**
- Fixed commercial commitments may be silently discounted
- Quotation totals may drift between preview/apply cycles
- Supplier-negotiated prices may be lost during refresh
- Catalog pricing may be incorrectly overwritten
- Legal disputes cannot be defended ("why did price change?")
- Future quotations may incorrectly inherit project-specific rates

**Why Beyond Schema:** Schema can block `discount_pct > 0`, but cannot enforce lifecycle behavior across apply-recalc, preview, refresh, and audit boundaries. This rule must govern runtime semantics, not just storage.

‚∏ª

## 3Ô∏è‚É£ Business Rationale (Why This Must Exist)

### Financial Risk Prevented
- **Revenue leakage:** Fixed prices accidentally discounted
- **Margin erosion:** Commercially agreed rates overridden by automation
- **Contract breach:** Supplier/customer agreed rates not honored
- **Project contamination:** Project-specific fixed rates leaking into catalog pricing

### Audit & Legal Risk Prevented
- **Non-defensible quotations:** Cannot prove a rate was fixed and protected
- **Dispute exposure:** "System recalculated price" is not a legal defense
- **Inconsistent snapshots:** Apply-recalc mutates protected prices

### User-Behavior Risk Prevented
- **Estimators accidentally applying discounts on fixed items:** Without hard constraint, UI/workflow may allow it
- **Reviewers assuming "apply-recalc is safe":** Must be explicitly blocked for fixed items
- **Developers reusing catalog pricing logic for fixed quotes:** Without explicit rule, future devs may "optimize it away"

### Why Common Sense Is Not Enough
- **Discount logic and reprice logic are generic by default:** Without explicit protection, fixed items get processed like normal items
- **Apply-recalc is designed to mutate values:** Must explicitly skip fixed items
- **Fixed pricing is exceptional behavior:** Must be explicitly protected, not assumed
- **Without a hard rule, future developers will "optimize it away":** Code evolves; explicit invariants protect against entropy

‚∏ª

## 4Ô∏è‚É£ Canonical Scope (Where It Applies)

| Dimension | Applies | Notes |
|-----------|---------|-------|
| Schema | ‚úÖ | **Primary enforcement** ‚Äî CHECK constraint enforces `discount_pct = 0` |
| Service Layer | ‚úÖ | **Primary enforcement** ‚Äî protects lifecycle behavior (apply-recalc, refresh) |
| Compute / Engine | ‚úÖ | **Deterministic handling** ‚Äî preview & apply must respect fixed rates |
| API / Validator | ‚úÖ | **Recommended** ‚Äî early rejection of discount attempts |
| Audit | ‚úÖ | **Mandatory** ‚Äî fixed-rate application must be audited |
| UI | ‚ùå | UI never authoritative (but should disable discount controls for fixed items) |

‚∏ª

## 5Ô∏è‚É£ Schema Behavior (Hard Guarantees)

### Tables & Columns

**Table:** `quote_bom_items`

**Relevant Columns:**
- `rate_source` (VARCHAR(50))
  - **DB Enum Values:** `'PRICELIST'`, `'MANUAL_WITH_DISCOUNT'`, `'FIXED_NO_DISCOUNT'`, `'UNRESOLVED'`
  - **Constraint:** `chk_quote_bom_items_rate_source` (enum check)
  - **Migration:** `20260104_110400_create_schema_canon_v1_0_l1_l2_quo_pricing.py` (line 448)

- `rate` (DECIMAL(15,2))
  - Stores the fixed rate (when `rate_source = 'FIXED_NO_DISCOUNT'`)
  - Default: `0`

- `discount_pct` (DECIMAL(5,2))
  - **Must be 0 when `rate_source = 'FIXED_NO_DISCOUNT'`**
  - Default: `0`
  - Range constraint: `discount_pct >= 0 AND discount_pct <= 100`

### CHECK Constraint (MANDATORY ‚Äî Primary Enforcement)

**Constraint Name:** `chk_quote_bom_item_rate_source` (singular "item")

**Location:** Migration `20260104_110400`, lines 459-462

**Constraint Logic:**
```sql
CHECK (
  (rate_source = 'FIXED_NO_DISCOUNT' AND discount_pct = 0) OR
  (rate_source != 'FIXED_NO_DISCOUNT')
)
```

**Guarantee:** Even if a developer bypasses service logic, the DB will reject discounting fixed-price items.

**Evidence:**
- Migration file: `backend/alembic/versions/20260104_110400_create_schema_canon_v1_0_l1_l2_quo_pricing.py`
- Lines 459-462: Exact CHECK constraint definition

### Explicit Absences (Critical)

- **‚ùå No FK to `sku_prices` for fixed pricing:** Fixed rates are stored directly on `quote_bom_items.rate`, not linked to catalog
- **‚ùå No schema rule forcing `rate_source = 'FIXED_NO_DISCOUNT'` to persist forever:** Lifecycle behavior is governed by service logic (not schema)
- **‚ùå No schema rule preventing catalog price list updates:** Fixed pricing is quotation-scoped; catalog remains independent

‚∏ª

## 6Ô∏è‚É£ Runtime Enforcement Semantics (Authoritative)

### 6.1 Allowed States

#### State A ‚Äî Fixed Quotation Pricing

- `rate_source = 'FIXED_NO_DISCOUNT'` (DB value)
- `rate = <fixed negotiated rate>` (DECIMAL(15,2), stored on line item)
- `discount_pct = 0` (enforced by schema + service)
- Item may exist alongside PRICELIST items in same quotation

**Creation:**
- Explicit user action (authorized role: Reviewer/Approver)
- Or system action during quotation import / negotiation flow
- **Storage:** Rate is stored on `quote_bom_items.rate` directly
- **Catalog:** Catalog price list (`sku_prices`) is never updated

**Quotation-Scoped Fixed Pricing (Critical Use Case):**
- Supplier provides project/quotation-specific fixed rate
- Rate is stored directly on `quote_bom_items.rate` with `rate_source = 'FIXED_NO_DISCOUNT'`
- `override_reason` should indicate "Project/quotation fixed rate" (if manual override columns are used)
- **SKU / price list is NOT modified:** Future quotations continue to use catalog pricing
- This ensures fixed pricing remains quotation-scoped, not catalog-contaminated

### 6.2 Blocked States

#### Blocked State 1 ‚Äî Discount Attempt on Fixed Item

- `rate_source = 'FIXED_NO_DISCOUNT'` AND `discount_pct > 0`

**Outcome:**
- ‚ùå **Rejected by schema CHECK constraint** (hard fail at DB layer)
- ‚ùå **Rejected by service validator** (early rejection before DB write)

**Enforcement Layers:**
- Schema: `chk_quote_bom_item_rate_source` constraint
- Service: Validator should check before attempting DB write

#### Blocked State 2 ‚Äî Apply-Recalc Mutation of Fixed Item

- Apply-recalc tries to overwrite `rate` for fixed items

**Outcome:**
- ‚ùå **Blocked in service/compute layer**
- ‚úÖ **Fixed rate is preserved verbatim** (not recalculated)

**Required Behavior:**
- Apply-recalc logic must check `rate_source = 'FIXED_NO_DISCOUNT'`
- Fixed items are skipped during rate resolution
- Fixed items retain their existing `rate` value

#### Blocked State 3 ‚Äî Implicit Price Refresh Mutation

- Pricelist refresh attempts to overwrite fixed item rate

**Outcome:**
- ‚ùå **Ignored** (fixed items excluded from refresh)
- ‚úÖ **Fixed items are skipped by resolver**

**Required Behavior:**
- Price refresh logic must skip items with `rate_source = 'FIXED_NO_DISCOUNT'`
- Fixed rates are not re-resolved from pricelist

#### Blocked State 4 ‚Äî Catalog Price List Contamination

- Attempt to update `sku_prices` table based on fixed quotation rate

**Outcome:**
- ‚ùå **Forbidden by design** (no code path should do this)
- ‚úÖ **Fixed pricing is quotation-scoped only**

**Required Behavior:**
- No code should write fixed quotation rates to `sku_prices` table
- Fixed rates live only on `quote_bom_items` table

### 6.3 When Enforcement Happens

| Event | Enforcement Layer | Behavior |
|-------|------------------|----------|
| **Create** | Validator + Service | If setting `rate_source = 'FIXED_NO_DISCOUNT'`, ensure `discount_pct = 0` |
| **Update (rate/discount)** | Validator + Schema | Schema CHECK blocks `discount_pct > 0` if `rate_source = 'FIXED_NO_DISCOUNT'` |
| **Update (rate_source change)** | Validator + Service | If changing to `FIXED_NO_DISCOUNT`, force `discount_pct = 0` |
| **Preview** | Compute | Compute respects fixed rate; no discount applied |
| **Apply-Recalc** | Service + Compute | **Fixed items skipped** (rate not recalculated) |
| **Delete** | A5 (is_locked) | Governed by A5 locking rules, not G-06 |
| **Price Refresh** | Service + Resolver | **Fixed items excluded** from refresh |

‚∏ª

## 7Ô∏è‚É£ Compute / Engine Semantics

### Deterministic Resolution Order

For each `quote_bom_item` during pricing calculation:

1. **If `rate_source = 'FIXED_NO_DISCOUNT'`:**
   - Use `rate` as-is (from `quote_bom_items.rate`)
   - Ignore SKU pricing (`sku_prices` table)
   - Ignore all discounts (line-level, quotation-level, rule-based)
   - **STOP** (no further resolution)

2. **Else:** Follow normal pricing resolution (G-04, G-05 rules apply)

### Calculation Formula

**For Fixed Items:**
```
line_amount = rate √ó quantity
```

- `discount_pct` is guaranteed 0 (enforced by schema)
- No discount calculations applied
- No alternative math paths permitted

**For Non-Fixed Items:**
Normal calculation applies (may include discounts, etc.)

### Idempotency Guarantee

- **Preview ‚Üí Apply produces identical results:** Fixed items have same rate in both
- **Re-applying apply-recalc is a no-op for fixed items:** Fixed rates are not recalculated
- **Price refresh cycles do not mutate fixed items:** Fixed rates are preserved across refreshes

### Discount Engine Behavior

**Discount Engine (`discount_engine.py`):**
- Must check `rate_source = 'FIXED_NO_DISCOUNT'` before applying discounts
- If fixed, skip discount application entirely
- No partial discounts, no quotation-level discount application

**Discount Resolver (`discount_resolver.py`):**
- Fixed items are excluded from discount rule resolution
- Precedence rules do not apply to fixed items

‚∏ª

## 8Ô∏è‚É£ Audit & Traceability Expectations

### Mandatory Audit Events

#### Event 1 ‚Äî Fixed Rate Applied

**Event Type:** `FIXED_RATE_APPLIED` (or equivalent)

**Required Fields:**
- `resource_type = 'quote_bom_item'`
- `resource_id = <line_item_id>`
- `action = 'fixed_rate_applied'`
- `user_id = <user_who_applied>`
- `timestamp = <application_timestamp>`

**Required Metadata:**
```json
{
  "rate": <fixed_rate_value>,
  "rate_source": "FIXED_NO_DISCOUNT",
  "reason": <reason_for_fixed_pricing>,
  "previous_rate": <previous_rate_if_changed>,
  "previous_rate_source": <previous_rate_source_if_changed>
}
```

**Enforcement:** Mandatory (audit failure = defect)

#### Event 2 ‚Äî Apply-Recalc Skips Fixed Item

**Event Type:** `APPLY_RECALC_SKIP_FIXED` (or equivalent)

**Required Fields:**
- `resource_type = 'quotation'` (or `'quote_bom_item'`)
- `resource_id = <quotation_id>` (or `line_item_id`)
- `action = 'apply_recalc_skip_fixed'`
- `user_id = <user_who_triggered_apply_recalc>`
- `timestamp = <recalc_timestamp>`

**Required Metadata:**
```json
{
  "line_item_id": <line_item_id>,
  "rate_source": "FIXED_NO_DISCOUNT",
  "preserved_rate": <fixed_rate_value>,
  "reason": "Fixed rate preserved during apply-recalc"
}
```

**Rationale:** Proves system intentionally preserved fixed price (not a bug or omission)

**Enforcement:** Mandatory for apply-recalc operations (audit failure = defect)

#### Event 3 ‚Äî Discount Attempt Blocked (Recommended)

**Event Type:** `DISCOUNT_BLOCKED_FIXED_RATE` (or equivalent)

**Recommended Fields:**
- `resource_type = 'quote_bom_item'`
- `resource_id = <line_item_id>`
- `action = 'discount_blocked'`
- `user_id = <user_who_attempted>`
- `timestamp = <attempt_timestamp>`

**Recommended Metadata:**
```json
{
  "rate_source": "FIXED_NO_DISCOUNT",
  "attempted_discount_pct": <attempted_value>,
  "reason": "Discount blocked: rate_source is FIXED_NO_DISCOUNT"
}
```

**Enforcement:** Recommended (not mandatory in MVP, but highly recommended for audit trail)

### Audit Non-Negotiable

- **Missing audit for fixed rate application = defect:** Cannot prove when/how fixed rate was set
- **Missing audit for apply-recalc skip = defect:** Cannot prove system intentionally preserved fixed rate
- **Fixed pricing without audit = invalid state:** Legal defensibility requires audit trail

### Audit Evidence Location

**Implementation:**
- `backend/app/audit/logger.py` (AuditLogger.log_event())

**Tests:**
- `backend/tests/phase5/test_apply_recalc.py` (apply-recalc audit)
- `backend/tests/phase5/test_pricing_resolver.py` (fixed rate audit)

‚∏ª

## 9Ô∏è‚É£ Explicit Non-Goals (VERY IMPORTANT)

### Does NOT Update Catalog Pricing

**Non-Goal:** G-06 does NOT update `sku_prices` table or catalog price list when fixed rates are set.

**Clarification:** Fixed pricing is quotation-scoped only. Catalog pricing (`sku_prices`) remains independent and is never modified by fixed quotation rates.

### Does NOT Propagate to Other Quotations

**Non-Goal:** G-06 does NOT propagate fixed rates from one quotation to another.

**Clarification:** Each quotation's fixed rates are independent. Future quotations use catalog pricing unless explicitly set to fixed.

### Does NOT Auto-Expire

**Non-Goal:** G-06 does NOT auto-expire fixed rates after a time period.

**Clarification:** Fixed rates persist until explicitly changed. Future extensions (time-bounded fixed rates) would require explicit governance decision + schema + doc update.

### Does NOT Block Edits (Unless A5 Lock Applies)

**Non-Goal:** G-06 does NOT prevent users from editing fixed rates or changing `rate_source`.

**Clarification:** G-06 only enforces that if `rate_source = 'FIXED_NO_DISCOUNT'`, then `discount_pct = 0`. It does NOT enforce read-only behavior. (That is handled by A5 is_locked or future workflow controls.)

### Does NOT Imply Approval Workflow

**Non-Goal:** G-06 does NOT imply that fixed rates require approval workflow.

**Clarification:** Fixed rates may be set by authorized roles (Reviewer/Approver), but approval workflow is a separate concern (future extension).

### Does NOT Cascade to Parent BOM/Panel/Quotation

**Non-Goal:** G-06 does NOT enforce that parent BOM/Panel/Quotation totals exclude discounts when child items are fixed.

**Clarification:** Parent totals are sums of line amounts. If a line is fixed and has no discount, its contribution to parent total reflects that. G-06 does not enforce parent-level discount exclusion.

‚∏ª

## üîü Failure & Recovery Semantics

### Failure Mode 1 ‚Äî Discount Attempt on Fixed Item

**Trigger:** User or system attempts to set `discount_pct > 0` when `rate_source = 'FIXED_NO_DISCOUNT'`

**Error Returned:**
- **HTTP Status:** 400 Bad Request
- **Error Code:** `FIXED_PRICE_DISCOUNT_FORBIDDEN`
- **Message:** "Discount cannot be applied to fixed-price items (rate_source = FIXED_NO_DISCOUNT)"

**Recovery:**
- **Manual:** User must either:
  - Remove discount (set `discount_pct = 0`)
  - Or change `rate_source` to a different value (if authorized)
- **Automatic:** None (security control, no auto-recovery)

**Who Can Recover:** Same user (just needs to remove discount) or authorized user (if changing rate_source)

### Failure Mode 2 ‚Äî Unauthorized Fixed Rate Set

**Trigger:** User with insufficient role attempts to set `rate_source = 'FIXED_NO_DISCOUNT'`

**Error Returned:**
- **HTTP Status:** 403 Forbidden
- **Error Code:** `FIXED_RATE_NOT_AUTHORIZED`
- **Message:** "Setting fixed pricing requires Reviewer or Approver role"

**Recovery:**
- **Manual:** User must obtain proper role or request fixed rate from authorized user
- **Automatic:** None (security control, no auto-recovery)

**Who Can Recover:** Authorized user (Reviewer/Approver) must perform the action

### Failure Mode 3 ‚Äî Internal Mutation Bug (Apply-Recalc)

**Trigger:** Apply-recalc logic incorrectly mutates fixed item rate (internal bug)

**Error Returned:**
- **HTTP Status:** 500 Internal Server Error
- **Error Code:** `FIXED_RATE_MUTATION_DETECTED`
- **Message:** "Internal error: Fixed rate was mutated during apply-recalc (should be preserved)"

**Recovery:**
- **Manual:** Admin must investigate apply-recalc logic, restore fixed rate from audit log
- **Automatic:** System should block operation and log audit event (fail-safe)

**Who Can Recover:** Developer/admin (code fix required) + admin (rate restoration)

### Failure Mode 4 ‚Äî Schema Constraint Violation

**Trigger:** DB CHECK constraint rejects `discount_pct > 0` for fixed item (rare, if service validator missed it)

**Error Returned:**
- **HTTP Status:** 400 Bad Request (or 500 if DB error surfaces as internal error)
- **Error Code:** `DB_CONSTRAINT_VIOLATION` / `FIXED_PRICE_DISCOUNT_FORBIDDEN`
- **Message:** "Database constraint violation: discount_pct must be 0 when rate_source = FIXED_NO_DISCOUNT"

**Recovery:**
- **Manual:** User must fix input (remove discount)
- **Automatic:** None (schema enforces invariant)

**Who Can Recover:** Same user (fix input)

‚∏ª

## 1Ô∏è‚É£1Ô∏è‚É£ Future Extension Rules (Controlled)

### Possible Extensions

#### Extension 1: Time-Bounded Fixed Rates

**What Could Be Extended:**
- Add `fixed_rate_expires_at` column
- System reverts to PRICELIST after expiration

**What MUST Happen Before Extension:**
1. **Decision:** Governance approval (affects audit trail and quotation lifecycle)
2. **Schema:** Add `fixed_rate_expires_at TIMESTAMP NULL` column
3. **Doc Update:** This micro-spec updated (Section 6.1 State A, add expiration logic)
4. **Resolver:** Update resolution logic to check expiration
5. **Audit:** Update audit to capture expiration events and revert actions
6. **Tests:** Comprehensive tests for expiration behavior

**Change Control:** Must follow Phase-5 Freeze-Gate process (or Phase-6 equivalent)

#### Extension 2: Fixed Rate with Tax-Only Adjustment

**What Could Be Extended:**
- Allow tax calculations on fixed rates (but no discount)
- New state: `rate_source = 'FIXED_WITH_TAX'` (hypothetical)

**What MUST Happen Before Extension:**
1. **Decision:** Governance approval
2. **Schema:** Add enum value + any tax-specific columns
3. **Doc Update:** This micro-spec + tax engine docs updated
4. **Resolver:** Update resolution logic
5. **Tests:** Comprehensive tests

**Change Control:** Must follow Freeze-Gate process

#### Extension 3: Contract-Linked Fixed Pricing

**What Could Be Extended:**
- Link fixed rates to contracts (FK to `contracts` table)
- Contract changes trigger fixed rate updates

**What MUST Happen Before Extension:**
1. **Decision:** Governance approval (affects contract management)
2. **Schema:** Add `contract_id FK` + contract change triggers
3. **Doc Update:** This micro-spec updated (contract linkage semantics)
4. **Audit:** Update audit to capture contract linkage and changes
5. **Tests:** Comprehensive tests

**Change Control:** Must follow Freeze-Gate process

### Extension Guardrails

**All extensions must:**
- Maintain discount immunity (core invariant)
- Maintain quotation-scoping (no catalog contamination)
- Maintain audit requirements (traceability is non-negotiable)
- Update this micro-spec (documentation is mandatory)

‚∏ª

## 1Ô∏è‚É£2Ô∏è‚É£ Freeze-Gate Declaration

- **Status:** üîí LOCKED
- **Effective Date:** 2026-01-27
- **Change Requires:** Phase-5 Senate approval

**Locked Guarantees:**
- Fixed prices are discount-immune (schema + service enforcement)
- Fixed prices are refresh-immune (apply-recalc skips fixed items)
- Fixed prices are audit-mandatory (application and skip events)
- Catalog pricing remains untouched (quotation-scoped only)
- Future quotations use catalog pricing (no contamination)

‚∏ª

---

**Micro-Spec Version:** 1.0  
**Based on Template:** Tier-1 Micro-Spec Template v1.0  
**Related Documents:**
- A1.7 (Original G-06 documentation)
- VALIDATION_GUARDRAILS_G1_G7.md (Consolidated guardrails)
- G-04 (RateSource consistency) ‚Äî related but separate concern
- A5 (is_locked) ‚Äî related but separate concern (delete protection)
- A6 (CostHead) ‚Äî related but separate concern

**Implementation Evidence:**
- `backend/alembic/versions/20260104_110400_create_schema_canon_v1_0_l1_l2_quo_pricing.py` (CHECK constraint, lines 459-462)
- `backend/app/estimation/discount_engine.py` (discount application logic)
- `backend/app/estimation/discount_resolver.py` (discount precedence rules)
- `backend/app/api/v1/endpoints/quotation.py` (_compute_quote_pricing)
- `backend/app/audit/logger.py` (audit logging)

**Schema Verification:**
- **Constraint Name:** `chk_quote_bom_item_rate_source` (singular "item")
- **DB Enum Values:** `'PRICELIST'`, `'MANUAL_WITH_DISCOUNT'`, `'FIXED_NO_DISCOUNT'`, `'UNRESOLVED'`
- **Migration:** `20260104_110400_create_schema_canon_v1_0_l1_l2_quo_pricing.py`

