✅ A3.7 — Tenant Isolation Convention (Freeze-Gate Spec)

Phase: Phase-5
Category: A — Freeze Gate Verification
Item: A3.7
Status: ✅ COMPLETED (Freeze-ready)
Date: 2026-01-27
Purpose: Lock canonical rules for tenant isolation so data access, integrity, and scalability remain safe across schema, APIs, and compute paths.

⸻

1) Canonical Rule Set (Locked)

TI1 — Tenant isolation is mandatory by default
	•	All business tables MUST include tenant_id BIGINT NOT NULL.
	•	Tenant isolation is opt-out, not opt-in.
	•	Any table without tenant_id must be explicitly documented as GLOBAL.

⸻

TI2 — Foreign key to tenants is mandatory
	•	Tenant-scoped tables MUST declare:
	•	tenant_id column
	•	FK to tenants.id
	•	FK naming MUST follow A3.3:
	•	fk_<table>__tenant_id__tenants

✅ Example:
fk_quote_bom_items__tenant_id__tenants

⸻

TI3 — Tenant filter discipline (read + write)
	•	Every read and write path MUST be tenant-filtered, unless the table is explicitly GLOBAL.
	•	This applies to:
	•	API endpoints
	•	background jobs
	•	batch imports
	•	preview / apply flows
	•	Never rely on "implicit" tenant context without enforcement.

⸻

TI4 — Indexing for tenant isolation (performance + safety)
	•	Tenant-scoped tables MUST have at least one index starting with tenant_id.
	•	Preferred patterns (see A3.3 IDX2):
	•	idx_<table>__tenant_id
	•	idx_<table>__tenant_id_<business_key>

✅ Examples:
	•	idx_categories__tenant_id_code
	•	idx_quotations__tenant_id_quote_no
	•	idx_quote_bom_items__tenant_id_quotation_id

⸻

TI5 — Composite uniqueness must include tenant_id
	•	Any uniqueness that applies "per tenant" MUST include tenant_id.

✅ Correct:
	•	UNIQUE (tenant_id, quote_no)
	•	UNIQUE (tenant_id, code)
	•	UNIQUE (tenant_id, quotation_id, scope_type, scope_key)

❌ Not allowed:
	•	UNIQUE (quote_no)
	•	UNIQUE (code) (unless explicitly GLOBAL)

⸻

TI6 — Cross-tenant joins are forbidden
	•	Joins across different tenant_id values are not allowed.
	•	All joins between tenant-scoped tables MUST include tenant alignment:
	•	either implicitly (same parent entity)
	•	or explicitly via tenant_id predicates.

This is a hard correctness rule, not just a performance guideline.

⸻

TI7 — Global tables (explicit exception list only)

A table may omit tenant_id only if:
	•	it is truly global by design, AND
	•	it is documented in the Data Dictionary as GLOBAL.

Phase-5 allowed GLOBAL tables (explicit):
	•	tenants (root)
	•	(No other tables are GLOBAL by default)

Anything else requires Phase-5 Senate approval.

⸻

TI8 — Audit and AI tables still require tenant context
	•	Audit tables (audit_logs) MUST store tenant_id, even though they are cross-cutting.
	•	AI telemetry tables (ai_call_logs, etc.) MUST store tenant_id.
	•	Cross-module does not mean cross-tenant.

⸻

TI9 — Imports and background jobs
	•	Import pipelines MUST:
	•	resolve tenant_id before inserting rows
	•	reject rows without a resolved tenant
	•	No "default tenant" fallback is allowed outside dev/test.

⸻

2) Examples (Aligned to SPEC-5)

✅ Good:
	•	quote_bom_items(tenant_id, quotation_id, …)
	•	sku_prices(tenant_id, catalog_sku_id, …)
	•	discount_rules(tenant_id, quotation_id, …)
	•	audit_logs(tenant_id, user_id, action, …)

❌ Not allowed:
	•	Business tables without tenant_id
	•	Global uniqueness without tenant_id
	•	Queries missing tenant filter "because ID is unique"

⸻

3) Enforcement Expectations
	•	All new migrations MUST:
	•	include tenant_id where applicable
	•	add FK to tenants.id
	•	add tenant-prefixed indexes
	•	All new APIs MUST:
	•	extract tenant context explicitly
	•	enforce tenant filtering at query boundaries
	•	Any deviation MUST include:
	•	justification in migration header, and
	•	note in Schema Canon / Data Dictionary change log.

⸻

4) Freeze Gate Compliance

Checklist Item: A3.7 — Tenant isolation convention
Status: ✅ VERIFIED
Approval: ✅ APPROVED

