✅ A3.6 — ID Strategy (PKs + Natural Keys + Tenant-Scoped Uniqueness) (Freeze-Gate Spec)

Phase: Phase-5
Category: A — Freeze Gate Verification
Item: A3.6
Status: ✅ COMPLETED (Freeze-ready)
Date: 2026-01-27
Purpose: Lock canonical rules for primary keys, tenant-scoped uniqueness, and when to use composite unique constraints so schema and APIs remain stable and scalable.

⸻

1) Canonical Rule Set (Locked)

ID1 — Primary key type (default)
	•	Default PK = id BIGINT (autoincrement / bigserial) for all tables.
	•	Use BIGINT consistently across FK references.

✅ Examples: tenants.id, quotations.id, quote_bom_items.id

⸻

ID2 — Tenant isolation key (mandatory where applicable)
	•	Tenant-scoped tables MUST include tenant_id BIGINT NOT NULL.
	•	Tenant isolation is enforced by:
	•	tenant_id column
	•	FK to tenants.id
	•	Index patterns (see A3.3 IDX2)

Tables exempt from tenant_id must be explicitly documented (rare).

⸻

ID3 — Natural key uniqueness must be tenant-scoped

If a business identifier exists, it MUST be unique within tenant (not global), unless explicitly global by design.

✅ Examples:
	•	categories: UNIQUE (tenant_id, code)
	•	products: UNIQUE (tenant_id, sku) (if enforced)
	•	catalog_skus: UNIQUE (tenant_id, make, oem_catalog_no) (preferred over global)

⸻

ID4 — Never use "name" alone as a unique key
	•	Names can change and can collide.
	•	If needed, use (tenant_id, code) or (tenant_id, <business_key>).
	•	name can be indexed for search, not for uniqueness (unless paired with code/type explicitly).

⸻

ID5 — Composite unique constraints: when to use

Use composite uniqueness when the relationship must be unique by definition:

✅ Required composite unique examples:
	•	discount_rules: UNIQUE (tenant_id, quotation_id, scope_type, scope_key)
	•	user_roles: UNIQUE (tenant_id, user_id, role_id) (or without tenant if implied via user_id)
	•	categories: UNIQUE (tenant_id, code)

❌ Avoid composites that block valid reuse:
	•	Do NOT make (quotation_id, product_id) unique on quote_bom_items (breaks G-08 reuse).

⸻

ID6 — Many-to-one mapping rule must not be blocked by uniqueness

When the system expects reuse (e.g., mapping multiple L1 to same SKU), do NOT add unique constraints that prevent it.

✅ Example:
	•	l1_l2_mappings MUST allow many L1 lines mapping to the same catalog_sku_id.
	•	So no unique constraint on catalog_sku_id alone.

⸻

ID7 — UUID usage (allowed only with justification)

UUID may be used only for:
	•	public/external identifiers exposed outside the system (e.g., share links, API tokens)
	•	security-sensitive identifiers where guessability matters

If used:
	•	Store as uuid type (or CHAR(36) as a fallback)
	•	Still keep an internal numeric id if DB performance and FK simplicity matter

Default Phase-5: BIGINT only.

⸻

ID8 — Reference columns must be deterministic and stable
	•	Store:
	•	quote_no as tenant-scoped business identifier: UNIQUE (tenant_id, quote_no)
	•	Any "external reference" as *_ref or *_code (string) with tenant-scoped uniqueness if required.

⸻

2) Examples (Aligned to SPEC-5)

✅ Good:
	•	id BIGINT PK everywhere
	•	tenant_id + code uniqueness for masters
	•	discount_rules uniqueness by scope
	•	quote_no unique within tenant

❌ Not allowed:
	•	Global uniqueness on business codes without tenant_id (unless explicitly global)
	•	Unique constraints that block reuse workflows (e.g., quote line SKU reuse)
	•	UUID everywhere "just because" (adds complexity without benefit)

⸻

3) Enforcement Expectations
	•	All new migrations MUST follow ID1–ID8.
	•	Any deviation MUST include:
	•	justification in migration header, and
	•	a note in Schema Canon / Data Dictionary change log.

⸻

4) Freeze Gate Compliance

Checklist Item: A3.6 — ID strategy
Status: ✅ VERIFIED
Approval: ✅ APPROVED

