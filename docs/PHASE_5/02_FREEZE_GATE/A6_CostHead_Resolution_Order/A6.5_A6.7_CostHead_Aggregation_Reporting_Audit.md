# A6.5‚ÄìA6.7 ‚Äî CostHead Aggregation, Reporting & Audit Semantics (Freeze-Gate Spec)

**Phase:** Phase-5  
**Category:** A ‚Äî Commercial Governance  
**Items Covered:** A6.5, A6.6, A6.7  
**Status:** üü¢ READY (Documentation-only, Freeze-Gate)  
**Date:** 2026-01-27  
**Owner:** Phase-5 Senate  
**Purpose:** Lock how CostHead participates in aggregation, reporting, and audit, ensuring deterministic financial outputs without contaminating pricing logic.

‚∏ª

## A6.5 ‚Äî CostHead Aggregation Semantics (LOCKED)

### 1) Canonical Principle

**CostHead affects aggregation and classification only ‚Äî never pricing.**
- Pricing is resolved before CostHead is considered
- CostHead is applied after line-item amount is finalized
- CostHead does not influence:
  - rate resolution
  - discount calculation
  - tax computation

‚∏ª

### 2) Aggregation Level (Authoritative)

CostHead aggregation is line-item driven.

| Level | CostHead Source | Allowed |
|-------|----------------|---------|
| Quote BOM Item | Resolved CostHead (A6.1‚ÄìA6.4) | ‚úÖ |
| BOM | SUM by CostHead | ‚úÖ |
| Panel | SUM by CostHead | ‚úÖ |
| Quotation | SUM by CostHead | ‚úÖ |

There is no CostHead on BOM / Panel / Quotation tables by design.

‚∏ª

### 3) Aggregation Formula (LOCKED)

For any aggregation scope S (BOM / Panel / Quotation):

```
For each CostHead CH:
    Total(CH) = Œ£ amount(line_item)
    WHERE resolved_cost_head(line_item) == CH
```

- No weighting
- No hierarchy propagation
- No reclassification at higher levels

‚∏ª

### 4) Interaction with is_locked (A5)
- `is_locked` does not affect aggregation
- Locked items:
  - ‚úÖ continue contributing to CostHead totals
  - ‚ùå cannot be deleted (per A5)
- Aggregation must remain stable and complete

‚∏ª

### 5) Failure & Safety Rules

| Scenario | Outcome |
|----------|---------|
| Line has NULL CostHead | Use resolved fallback (A6.4) |
| CostHead deleted mid-quote | SET NULL ‚Üí fallback resolution |
| Mixed CostHeads in same BOM | Expected and allowed |

**No aggregation failure is permitted.**

‚∏ª

## A6.6 ‚Äî CostHead Reporting Semantics (LOCKED)

### 1) Reporting Scope

CostHead is report-facing, not workflow-facing.

**Primary consumers:**
- Cost summary views
- Margin analysis
- ERP / accounting exports
- Management dashboards

‚∏ª

### 2) Mandatory Reporting Guarantees

Every quotation must produce:

| Output | Requirement |
|--------|-------------|
| Total cost per CostHead | ‚úÖ Mandatory |
| Zero-amount CostHeads | ‚ùå Optional (usually omitted) |
| Unclassified bucket | ‚ùå Not allowed (must resolve) |

"Unclassified" lines are a governance failure, not a valid state.

‚∏ª

### 3) Determinism Rules (LOCKED)

Given the same:
- quotation data
- product defaults
- CostHead master

‚Ä¶the CostHead report must be identical, regardless of:
- execution order
- preview vs apply
- user role

‚∏ª

### 4) Apply-Recalc Interaction
- CostHead totals are not snapshotted
- They are derived dynamically from stored line-item data
- Apply-Recalc:
  - may change amount
  - does not directly change CostHead assignment

‚∏ª

### 5) Export & Downstream Expectations

| Export Type | CostHead Role |
|-------------|---------------|
| ERP export | Mandatory mapping key |
| Accounting | Primary classification |
| BI / Analytics | Grouping dimension |
| Audit extract | Classification context |

‚∏ª

## A6.7 ‚Äî CostHead Audit & Governance Semantics (LOCKED)

### 1) Audit Philosophy

CostHead is classification-critical, not pricing-critical ‚Äî but still audit-relevant.

Audit focuses on:
- changes in classification
- changes in interpretation, not totals

‚∏ª

### 2) Recommended Audit Events (Governance-Level)

| Event | Trigger |
|-------|---------|
| `COSTHEAD_OVERRIDE_SET` | `quote_bom_items.cost_head_id` set |
| `COSTHEAD_OVERRIDE_CHANGED` | Override modified |
| `COSTHEAD_OVERRIDE_REMOVED` | Override cleared |
| `COSTHEAD_MASTER_UPDATED` | `cost_heads` edited |
| `COSTHEAD_MASTER_DEACTIVATED` | `is_active` ‚Üí false |

These events are recommended, not schema-blocking for MVP.

‚∏ª

### 3) Audit Payload (Suggested)

```json
{
  "entity": "quote_bom_items",
  "entity_id": 12345,
  "old_cost_head_id": 4,
  "new_cost_head_id": 7,
  "resolved_fallback": "PRODUCT_DEFAULT",
  "changed_by": 901,
  "changed_at": "2026-01-27T14:32:10Z"
}
```

‚∏ª

### 4) Governance Controls (LOCKED)
- CostHead master changes:
  - should be restricted to Admin / Finance roles
- CostHead meaning must remain stable:
  - renaming allowed
  - semantic repurposing not allowed without migration + decision

‚∏ª

### 5) Explicit Non-Goals
- ‚ùå No CostHead versioning in MVP
- ‚ùå No historical re-classification of past quotes
- ‚ùå No CostHead-based access control
- ‚ùå No automatic CostHead inference by AI

‚∏ª

## A6 Closure Statement (A6.1‚ÄìA6.7)

### What Is Now Fully Locked
1. CostHead master governance
2. Resolution precedence (line ‚Üí product ‚Üí system)
3. Aggregation semantics
4. Reporting guarantees
5. Audit expectations
6. Runtime enforcement layer (Service)

### What Is Explicitly Deferred
- Versioned CostHead history
- Hierarchical locking
- Edit restrictions tied to is_locked
- AI-driven classification

‚∏ª

## Freeze-Gate Status

- **A6.5:** ‚úÖ VERIFIED
- **A6.6:** ‚úÖ VERIFIED
- **A6.7:** ‚úÖ VERIFIED

**A6 COMPLETE ‚Äî Freeze-Gate Approved**

‚∏ª

## References

- A6.1‚ÄìA6.4 Governance: `A6.1_A6.4_CostHead_Governance_and_Runtime_Semantics.md`
- A6.5 Resolution Order: `A6.5_CostHead_Resolution_Order.md`
- A6.6 Precedence Rules: `A6.6_CostHead_Precedence_Rules.md`
- A6.7 Checklist Update: `A6.7_Update_Checklist_and_DataDictionary_A6.md`
- A5 IsLocked Scope: `../A5_IsLocked_Scope/`
- A7 Runtime Enforcement: `../A7_Post_Schema_Governance_Controls/`

