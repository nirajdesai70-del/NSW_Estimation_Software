# A6-COST-01 ‚Äî CostHead Resolution Order (Tier-1 Micro-Spec)

> **‚ö†Ô∏è IMPORTANT (Additive Only): This is an ADDITIVE enhancement to A6.1‚ÄìA6.7, not a replacement.**  
> Primary references remain A6.1/A6.2 and the A6.5‚ÄìA6.7 decision docs (once finalized).  
> This micro-spec adds Tier-1 depth: runtime semantics, failure/recovery, and extension control.

**Phase:** Phase-5  
**Category:** A ‚Äî Governance / Runtime Control (Tier-1)  
**Rule ID:** A6-COST-01  
**Status:** üîí LOCKED  
**Effective Date:** 2026-01-27  
**Template:** Tier-1 Micro-Spec Template v1.0  
**Primary References:** A6.1‚ÄìA6.7 (Freeze-Gate)

‚∏ª

## 1Ô∏è‚É£ Rule Identifier

- **Rule ID:** A6-COST-01
- **Category:** Governance / Cost Classification / Financial Reporting Integrity
- **Phase Introduced:** Phase-5
- **Risk Class:** üî¥ Tier-1 (Financial / Audit / Reporting)

‚∏ª

## 2Ô∏è‚É£ Intent (What This Rule Protects)

**Protection:** CostHeads drive cost rollups, reporting buckets, margin visibility, and downstream analytics. This rule guarantees that every quotation line is classified deterministically and consistently‚Äîwithout "hidden defaults" or inconsistent interpretations across API, compute, and reports.

**If Violated:**
- Same item shows under different cost buckets across screens/reports
- Margin reports become non-defensible
- Post-apply recalcs shift classification unexpectedly
- Audit cannot explain why a line landed in a particular cost head
- Financial reporting becomes unreliable and non-auditable

**Why Beyond Schema:** Schema defines FKs and nullable behavior, but cannot enforce precedence order, fallback logic, or deterministic resolution. Runtime service layer must enforce the canonical precedence chain.

‚∏ª

## 3Ô∏è‚É£ Business Rationale (Why Ad-Hoc Handling Is Not Enough)

### Financial Risk
- **Wrong bucket = wrong cost summary = wrong margin view = wrong decisions:** CostHead misclassification directly impacts financial reporting and business decisions

### Audit Risk
- **Reviewers will ask: "How was this classified?":** If it's not deterministic and documented, the system is not defensible
- **Non-auditable classification:** Cannot prove why a line item was assigned to a particular cost head

### Operational Risk
- **Engineers/estimators will apply "workarounds" (manual edits):** Unless precedence rules are clear and stable, users will create inconsistent classifications
- **System drift:** Without explicit rules, different code paths may resolve CostHead differently

‚∏ª

## 4Ô∏è‚É£ Canonical Scope (Where It Applies)

| Dimension | Applies | Notes |
|-----------|---------|-------|
| Schema | ‚úÖ | FKs + nullable behavior define what's possible |
| Service Layer | ‚úÖ | **Primary enforcement** ‚Äî resolution precedence + fallback handling |
| Compute Engine | ‚ö†Ô∏è | Uses resolved result; engine should not invent CostHead |
| API / Validator | ‚úÖ | Must accept explicit line override and validate FK integrity |
| Audit | ‚ö†Ô∏è | Recommended now; mandatory when cost-head edits become governed |
| UI | ‚ùå | UI never authoritative |

‚∏ª

## 5Ô∏è‚É£ Schema Behavior (Hard Guarantees)

### 5.1 Tables/Columns (Facts)

#### Table: `cost_heads`

**Columns (Core):**
- `id` (BIGINT, PK, autoincrement)
- `tenant_id` (BIGINT, NOT NULL, FK to `tenants.id`)
- `code` (VARCHAR(100), NOT NULL) ‚Äî Canonical business key
- `name` (VARCHAR(255))
- `category` (VARCHAR(50)) ‚Äî CHECK constraint: `IN ('MATERIAL', 'LABOUR', 'OTHER')`
- `priority` (INTEGER, default 0)
- `description` (TEXT, nullable)
- `is_active` (BOOLEAN, default true)
- `created_at`, `updated_at` (TIMESTAMP)

**Constraints:**
- Unique: `(tenant_id, code)` ‚Äî Deterministic uniqueness per tenant
- CHECK: `chk_cost_heads_category` ‚Äî Category enum enforcement

**Evidence:**
- **Migration:** `backend/alembic/versions/20260104_110400_create_schema_canon_v1_0_l1_l2_quo_pricing.py`
- **Lines 20-40:** Table definition, constraints, indexes
- **A6.1 Verification:** `A6.1_Verify_cost_heads_table_exists.md` (verified present)

#### Table: `quote_bom_items`

**Column:** `cost_head_id`
- **Type:** `BIGINT`
- **Nullable:** Yes (line item override is optional)
- **FK:** `quote_bom_items.cost_head_id ‚Üí cost_heads.id`
- **On-Delete Policy:** `SET NULL` (safe, because reference is optional)
- **Index:** `idx_quote_bom_items_cost_head_id` (non-unique, for query performance)

**Evidence:**
- **Migration:** Line 440 (column definition), Line 472 (FK constraint), Line 481 (index)
- **A6.2 Verification:** `A6.2_Verify_quote_bom_items_cost_head_id.md` (verified present)

#### Table: `products` (Transitional, Current Binding)

**Column:** `cost_head_id` (if present in schema)
- **Type:** `BIGINT`
- **Nullable:** Yes (product default is optional)
- **FK:** `products.cost_head_id ‚Üí cost_heads.id`
- **On-Delete Policy:** `SET NULL` (safe default)
- **Index:** `idx_products_cost_head_id` (non-unique)

**Evidence:**
- **Migration:** Line 55 (column definition), Line 66 (FK constraint), Line 77 (index)
- **A6.4 Verification:** `A6.4_Verify_products_cost_head_id.md` (verified present)

### 5.2 Explicit Absences (Important)

- ‚ùå **No DB constraint forces `quote_bom_items.cost_head_id` to be NOT NULL**

**Rationale:** Line override is optional; NULL is allowed and must be handled by precedence logic.

- ‚ùå **No DB trigger auto-assigns `cost_head_id`**

**Rationale:** CostHead resolution must be a runtime rule, not a DB side effect. This ensures deterministic, auditable behavior.

- ‚ùå **No DB constraint enforces precedence order**

**Rationale:** Precedence is a service-layer policy, not a schema constraint. Schema provides the structure; service enforces the logic.

‚∏ª

## 6Ô∏è‚É£ Runtime Enforcement Semantics (Authoritative)

### 6.1 Allowed States (Canonical)

**Let:**
- `L_override = quote_bom_items.cost_head_id` (line-level override)
- `P_default = products.cost_head_id` (product default, if product exists)
- `SYS_default = tenant/config default` (optional ‚Äî see Section 6.4)

#### Allowed State A ‚Äî Line Override Present (Highest Priority)

- **Condition:** `L_override != NULL`
- **Resolution:** Use `L_override`, always
- **Behavior:** Line-level override takes precedence over all other sources

**Example:**
```
quote_bom_items.cost_head_id = 5 (MATERIAL)
products.cost_head_id = 3 (LABOUR)
‚Üí Resolved CostHead = 5 (MATERIAL) ‚úÖ
```

#### Allowed State B ‚Äî No Line Override, Product Default Present

- **Condition:** `L_override == NULL AND P_default != NULL`
- **Resolution:** Use `P_default`
- **Behavior:** Product default is used when line override is not set

**Example:**
```
quote_bom_items.cost_head_id = NULL
products.cost_head_id = 3 (LABOUR)
‚Üí Resolved CostHead = 3 (LABOUR) ‚úÖ
```

#### Allowed State C ‚Äî No Line Override, No Product Default

- **Condition:** `L_override == NULL AND P_default == NULL`
- **Resolution:** Use `SYS_default` only if explicitly configured and documented; otherwise return `NULL` and classify as "UNMAPPED"

**Behavior:**
- If `SYS_default` is configured: Use system default
- If `SYS_default` is NOT configured: Return `NULL` (resolved_cost_head_id = NULL)

**Example:**
```
quote_bom_items.cost_head_id = NULL
products.cost_head_id = NULL
SYS_default = 1 (MATERIAL) [if configured]
‚Üí Resolved CostHead = 1 (MATERIAL) ‚úÖ

OR (if SYS_default not configured):
‚Üí Resolved CostHead = NULL (UNMAPPED) ‚úÖ
```

### 6.2 Blocked States

#### Blocked State 1 ‚Äî Service Invents CostHead by Guessing

- **Blocked:** Service invents a CostHead by guessing category/make/series or other heuristics
- **Rationale:** CostHead is a governance master; guessing creates non-auditable behavior
- **Outcome:** ‚ùå **BLOCKED** ‚Äî Service must use explicit precedence chain only

#### Blocked State 2 ‚Äî Apply-Recalc Changes CostHead Implicitly

- **Blocked:** Apply-Recalc changes CostHead implicitly (without user action)
- **Rationale:** CostHead resolution must not "shift" because prices changed
- **Outcome:** ‚ùå **BLOCKED** ‚Äî Apply-Recalc must not mutate CostHead unless user explicitly changed it

#### Blocked State 3 ‚Äî Inconsistent Resolution Across Endpoints

- **Blocked:** Different endpoints resolve CostHead differently
- **Rationale:** Determinism requires consistent resolution logic
- **Outcome:** ‚ùå **BLOCKED** ‚Äî All endpoints must use same precedence logic

### 6.3 When Enforcement Happens

| Event | Enforcement | Required Behavior |
|-------|-------------|-------------------|
| **Create line item** | Service | Allow `cost_head_id` to be set explicitly (override) or left NULL |
| **Update line item** | Service | Allow changing `cost_head_id` explicitly (override) |
| **Preview** | Compute | Display resolved CostHead using precedence (but should NOT write it) |
| **Apply-Recalc** | Service | Must NOT mutate CostHead unless user explicitly changed `quote_bom_items.cost_head_id` as part of the action |
| **Delete CostHead master row** | DB + Service | DB will SET NULL safely; service must handle NULL resolution deterministically |

### 6.4 System Default (Strict Governance)

**SYS_default is OPTIONAL.** If used, it must be:

1. **Tenant-scoped:** Each tenant may have different system default
2. **Explicitly configured:** Not inferred or guessed
3. **Explicitly documented:** Data Dictionary + Schema Canon must document system default configuration
4. **Never inferred:** Must be explicit configuration, not derived from other data

**If SYS_default is NOT implemented yet:**
- Return `NULL` (resolved_cost_head_id = NULL)
- Downstream rollups must show bucket "UNMAPPED/UNCLASSIFIED" deterministically
- UI should prompt user to assign CostHead (but this is advisory, not authoritative)

‚∏ª

## 7Ô∏è‚É£ Compute / Engine Semantics

### 7.1 What Compute Must Do

**Required Behavior:**
- **Compute uses resolved CostHead to group totals (reporting bucket):** Rollups group by resolved CostHead
- **Compute must NOT auto-fix or auto-write a missing `cost_head_id`:** Compute is read-only for CostHead assignment
- **Compute should be deterministic:** Same inputs ‚Üí same resolved_cost_head_id

**Formula (Unchanged by CostHead):**
```
line_amount = rate √ó quantity √ó (1 - discount_pct/100)
quotation_total = SUM(line_amount) for all items
```

**CostHead affects grouping, not calculation:**
```
cost_head_total = SUM(line_amount) for all items WHERE resolved_cost_head_id = X
```

### 7.2 Rollup Behavior (Deterministic)

**Required Behavior:**
- **If resolved_cost_head_id is NULL ‚Üí bucket under UNMAPPED:** Single reserved bucket label
- **Never split NULL into multiple buckets:** No ambiguity allowed

**Rollup Example:**
```
Line 1: resolved_cost_head_id = 1 (MATERIAL) ‚Üí amount = 1000
Line 2: resolved_cost_head_id = 2 (LABOUR) ‚Üí amount = 500
Line 3: resolved_cost_head_id = NULL (UNMAPPED) ‚Üí amount = 300

Rollup:
- MATERIAL: 1000
- LABOUR: 500
- UNMAPPED: 300
- Total: 1800
```

**Blocked Behavior:**
- ‚ùå Grouping NULL into multiple buckets (e.g., "NULL-MATERIAL", "NULL-LABOUR")
- ‚ùå Auto-assigning CostHead during rollup calculation
- ‚ùå Changing CostHead based on line amount or other heuristics

‚∏ª

## 8Ô∏è‚É£ Audit & Traceability Expectations

### 8.1 Recommended Now (Minimum Viable Defensibility)

**When a user explicitly changes `quote_bom_items.cost_head_id`, log:**

#### Event: COST_HEAD_OVERRIDE_SET

**Event Type:** `COST_HEAD_OVERRIDE_SET`

**Minimum Fields:**
- `tenant_id` (BIGINT)
- `user_id` (BIGINT) ‚Äî User who set the override
- `resource_type = 'quote_bom_item'`
- `resource_id = <line_item_id>`
- `action = 'COST_HEAD_OVERRIDE_SET'`
- `timestamp` (TIMESTAMP)

**Minimum Metadata:**
```json
{
  "old_cost_head_id": <previous_value_or_null>,
  "new_cost_head_id": <new_value>,
  "reason": "<optional_reason_if_captured>"
}
```

**Enforcement:** Recommended (not mandatory in MVP, but highly recommended for audit defensibility)

### 8.2 Mandatory Later (When Governance Tightens)

**If/when you introduce:**
- Approval workflow for cost heads
- Lock/unlock around quotation finalization
- Reporting export compliance

**Then audit becomes mandatory for:**
- CostHead overrides (COST_HEAD_OVERRIDE_SET)
- Product default CostHead changes (if product master is editable)
- System default changes (if system default is configurable)

**Additional Mandatory Events (Future):**
- `COST_HEAD_PRODUCT_DEFAULT_CHANGED` (if product master editable)
- `COST_HEAD_SYSTEM_DEFAULT_CHANGED` (if system default configurable)
- `COST_HEAD_RESOLUTION_FAILED` (if resolution logic encounters errors)

‚∏ª

## 9Ô∏è‚É£ Explicit Non-Goals (VERY IMPORTANT)

### Does NOT Require `cost_head_id` to Be Set on Every Line in DB

**Non-Goal:** CostHead resolution does NOT require every line to have a non-NULL `cost_head_id` in the database.

**Clarification:** NULL is allowed and must be handled deterministically (resolved to UNMAPPED bucket).

### Does NOT Infer CostHead from Category/Make/Series

**Non-Goal:** CostHead resolution does NOT use heuristics (category, make, series) to guess CostHead.

**Clarification:** CostHead must come from explicit precedence chain (line override ‚Üí product default ‚Üí system default), not from inference.

### Does NOT Auto-Write CostHead During Apply-Recalc

**Non-Goal:** Apply-Recalc does NOT automatically populate `cost_head_id` if it's NULL.

**Clarification:** Apply-Recalc preserves existing CostHead state. It does not mutate CostHead unless user explicitly changed it.

### Does NOT Change CostHead Because Pricing Changed

**Non-Goal:** CostHead resolution does NOT change when pricing changes.

**Clarification:** CostHead is independent of pricing. Rate changes, discount changes, or price refreshes do not affect CostHead resolution.

### Does NOT Introduce Hierarchy-Level CostHead (BOM/Panel/Quotation)

**Non-Goal:** CostHead resolution does NOT use BOM-level, panel-level, or quotation-level CostHead defaults.

**Clarification:** CostHead precedence is: Line override ‚Üí Product default ‚Üí System default. Higher-level defaults are not part of MVP scope.

‚∏ª

## üîü Failure & Recovery Semantics

### Failure Mode 1 ‚Äî `cost_head_id` Points to Missing CostHead

**Trigger:** Invalid FK (should be prevented by FK constraint, but may occur if FK is temporarily violated)

**Error Returned:**
- **HTTP Status:** 400 Bad Request (or 500 if DB constraint violation surfaces)
- **Error Code:** `INVALID_COST_HEAD_ID` or `FK_CONSTRAINT_VIOLATION`
- **Message:** "Invalid CostHead ID: cost_head_id does not exist or is not accessible"

**Recovery:**
- **Manual:** User must select a valid CostHead from available options
- **Automatic:** None (data integrity issue, requires user correction)

**Who Can Recover:** User (select valid CostHead) or admin (if FK constraint needs repair)

### Failure Mode 2 ‚Äî CostHead Deleted After Being Referenced

**Trigger:** Admin deletes `cost_heads` row that is referenced by `quote_bom_items` or `products`

**DB Behavior:**
- **FK On-Delete Policy:** `SET NULL` (safe default)
- **Result:** `cost_head_id` is set to NULL automatically by DB

**Service Behavior:**
- **Resolution:** Service must handle NULL resolution deterministically
- **Outcome:** Resolved CostHead becomes NULL ‚Üí classified as "UNMAPPED"

**Recovery:**
- **Manual:** User/admin re-assigns CostHead to affected lines
- **OR:** Accept "UNMAPPED" bucket (if acceptable for reporting)

**Who Can Recover:** User (re-assign CostHead) or admin (bulk re-assignment if needed)

### Failure Mode 3 ‚Äî Reports Show NULL Bucket

**Trigger:** Neither line override nor product default exists (and SYS_default not configured)

**Result:**
- **Stable "UNMAPPED" classification:** NULL is handled deterministically
- **Reporting:** Lines appear in "UNMAPPED/UNCLASSIFIED" bucket

**Recovery:**
- **Manual:** Assign line override (if user has permission)
- **OR:** Set product default (if product master is editable and user has permission)
- **OR:** Configure system default (if admin has permission)

**Who Can Recover:** User (line override), product admin (product default), system admin (system default)

### Failure Mode 4 ‚Äî Inconsistent Resolution Logic

**Trigger:** Different code paths resolve CostHead differently (bug)

**Error Returned:**
- **No explicit error** ‚Äî system silently produces inconsistent results
- **User Impact:** Same line shows different CostHead in different views/reports

**Recovery:**
- **Immediate:** Fix resolution logic to use consistent precedence
- **Investigation:** Review all code paths that resolve CostHead
- **Prevention:** Unit tests must cover all precedence scenarios

**Who Can Recover:** Developer (code fix) + QA (test coverage)

‚∏ª

## 1Ô∏è‚É£1Ô∏è‚É£ Future Extension Rules (Controlled)

### Extension A ‚Äî Introduce SYS_default Config Table

**What Could Be Extended:**
- Add `tenant_cost_head_defaults` table (tenant_id, default_cost_head_id)
- System default becomes configurable per tenant

**What MUST Happen Before Extension:**
1. **Decision:** Governance approval (explicit decision on system default configuration)
2. **Schema:** Migration adding config table
3. **Runtime:** Update resolution logic to read from config table
4. **Doc Update:** This micro-spec updated (add SYS_default semantics to Section 6.1 State C, Section 6.4)
5. **Data Dictionary:** Document system default configuration
6. **Audit:** Update audit to capture system default changes
7. **Tests:** Comprehensive tests for system default resolution

**Change Control:** Must follow Phase-5 Freeze-Gate process (or Phase-6 equivalent)

### Extension B ‚Äî Add CostHead Approval Workflow

**What Could Be Extended:**
- CostHead assignments require approval before taking effect
- Approval workflow for line overrides, product defaults, system defaults

**What MUST Happen Before Extension:**
1. **Decision:** Governance approval (workflow requirements)
2. **Schema:** Add approval status columns (if needed)
3. **Runtime:** Implement approval workflow logic
4. **Doc Update:** This micro-spec updated (add approval semantics)
5. **Audit:** Mandatory audit for approval actions
6. **Tests:** Comprehensive tests for approval workflow

**Change Control:** Must follow Freeze-Gate process

### Extension C ‚Äî Add Lock-Based Restriction (CostHead Edits Blocked After FINALIZED)

**What Could Be Extended:**
- CostHead edits blocked when quotation status = FINALIZED
- Lock prevents CostHead changes after finalization

**What MUST Happen Before Extension:**
1. **Decision:** Governance approval (finalization semantics)
2. **Schema:** No schema changes needed (uses existing status field)
3. **Runtime:** Update mutation endpoints to check status
4. **Doc Update:** This micro-spec updated (add finalization lock semantics)
5. **Audit:** Update audit to capture blocked CostHead changes
6. **Tests:** Comprehensive tests for finalization lock

**Change Control:** Must follow Freeze-Gate process

### Extension Guardrails

**All extensions must:**
- Maintain core precedence order: Line override ‚Üí Product default ‚Üí System default
- Maintain deterministic resolution (same inputs ‚Üí same outputs)
- Update this micro-spec (documentation is mandatory)
- Preserve audit requirements (traceability is non-negotiable)

‚∏ª

## 1Ô∏è‚É£2Ô∏è‚É£ Freeze-Gate Declaration

- **Status:** üîí LOCKED
- **Effective Date:** 2026-01-27
- **Change Requires:** Phase-5 Senate approval

**Locked Guarantees:**
- Precedence order is: Line override ‚Üí Product default ‚Üí System default
- Resolution is deterministic (same inputs ‚Üí same outputs)
- NULL is handled deterministically (UNMAPPED bucket)
- Apply-Recalc does not mutate CostHead implicitly
- Future extensions require explicit governance approval

‚∏ª

---

**Micro-Spec Version:** 1.0  
**Based on Template:** Tier-1 Micro-Spec Template v1.0  
**Related Documents:**
- A6.1 (CostHead master table verification)
- A6.2 (Line override verification)
- A6.3 (Product default decision)
- A6.4 (Product default verification)
- A6.5 (Resolution order ‚Äî primary reference)
- A6.6 (Precedence rules)
- A6.7 (Checklist/data dictionary closure)
- G-04 (RateSource consistency ‚Äî related but separate concern)
- A5 (is_locked ‚Äî related but separate concern)

**Implementation Evidence:**
- `backend/alembic/versions/20260104_110400_create_schema_canon_v1_0_l1_l2_quo_pricing.py` (schema definitions)
- `cost_heads` table (lines 20-40)
- `quote_bom_items.cost_head_id` (line 440, FK line 472, index line 481)
- `products.cost_head_id` (line 55, FK line 66, index line 77)

**Schema Verification:**
- **CostHead Master:** `cost_heads` table exists with required columns and constraints
- **Line Override:** `quote_bom_items.cost_head_id` (BIGINT, nullable, FK with SET NULL)
- **Product Default:** `products.cost_head_id` (BIGINT, nullable, FK with SET NULL)
- **System Default:** Not yet implemented (optional future extension)

