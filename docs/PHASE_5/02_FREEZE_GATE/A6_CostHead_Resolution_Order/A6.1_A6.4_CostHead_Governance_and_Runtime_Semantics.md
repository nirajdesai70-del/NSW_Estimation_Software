# A6.1‚ÄìA6.4 ‚Äî CostHead Governance & Runtime Semantics (Freeze-Gate Spec)

**Phase:** Phase-5  
**Category:** A ‚Äî Commercial Governance  
**Items Covered:** A6.1, A6.2, A6.3, A6.4  
**Status:** üü¢ READY (Documentation-only, Freeze-Gate)  
**Date:** 2026-01-27  
**Owner:** Phase-5 Senate  
**Purpose:** Define authoritative governance, runtime behavior, and safety rules for CostHead usage across quotation pricing, ensuring deterministic costing, tenant isolation, and auditability.

‚∏ª

## 0) Why A6 Needs Governance (Context)

CostHead is not just a lookup. It affects:
- Cost rollups
- Margin analysis
- Reporting correctness
- Downstream accounting mappings

Therefore:
- Schema presence alone is not sufficient
- Runtime precedence, mutation rules, and failure behavior must be locked

This document closes the semantic gap between:
- A6 schema verification
- Runtime implementation
- Audit & governance expectations

‚∏ª

## 1) A6.1 ‚Äî CostHead Master (cost_heads) Governance

### 1.1 Canonical Role of cost_heads

`cost_heads` is the single system-wide master for cost classification.

It is:
- Tenant-scoped
- Reference-only from transactional tables
- Non-derivable (cannot be inferred or auto-created)

### 1.2 Allowed Semantics

Each CostHead represents a mutually exclusive cost bucket, not a pricing rule.

**Examples:**
- `OEM_MATERIAL`
- `LABOUR`
- `FABRICATION`
- `LOGISTICS`
- `SERVICE`

### 1.3 Governance Rules (LOCKED)

| Rule | Status |
|------|--------|
| Tenant isolation mandatory | ‚úÖ |
| (tenant_id, code) uniqueness | ‚úÖ |
| CostHead category enum enforced | ‚úÖ |
| CostHead deletion must not cascade | ‚úÖ |
| CostHead meaning is stable | ‚úÖ |

**Important:** CostHead is classification, not computation.
It must never affect price calculation logic directly.

‚∏ª

## 2) A6.2 ‚Äî Line-Item CostHead Override (quote_bom_items.cost_head_id)

### 2.1 Role of Line-Item Override

`quote_bom_items.cost_head_id` is the highest-priority override in CostHead resolution.

It exists to support:
- Exceptional classification
- Customer-specific costing
- Engineering judgement overrides

### 2.2 Mutation Rules (LOCKED)

| Operation | Allowed | Notes |
|-----------|---------|-------|
| Set cost_head_id | ‚úÖ | Nullable |
| Change cost_head_id | ‚úÖ | Treated as financial classification change |
| Delete referenced cost_head | ‚úÖ | FK SET NULL |
| Mass update via Apply-Recalc | ‚ùå | CostHead is not recomputed |

### 2.3 Interaction with is_locked (A5)
- `is_locked = true` does not block changing `cost_head_id`
- **Rationale:** Lock protects structure, not classification (MVP)

Any future rule like "locked item cannot change CostHead" requires a new decision.

‚∏ª

## 3) A6.3 ‚Äî Product-Level Default (products.cost_head_id) Governance

### 3.1 Purpose of Product Default

`products.cost_head_id` acts as a fallback default, not an enforced classification.

It exists to:
- Reduce repetitive manual entry
- Encode domain defaults (e.g., most contactors ‚Üí `OEM_MATERIAL`)

### 3.2 Precedence Position

Product default is only consulted if:
- Line-item override is NULL

### 3.3 Governance Rules (LOCKED)

| Rule | Status |
|------|--------|
| Optional field (nullable) | ‚úÖ |
| Never auto-persisted to line | ‚úÖ |
| Used only at compute time | ‚úÖ |
| Safe deletion (SET NULL) | ‚úÖ |

### 3.4 What Product Default Is Not
- ‚ùå Not a constraint
- ‚ùå Not copied automatically into `quote_bom_items`
- ‚ùå Not a pricing rule
- ‚ùå Not applied during schema migrations

‚∏ª

## 4) A6.4 ‚Äî System Default CostHead (Implicit, Last Resort)

### 4.1 Why System Default Exists

To guarantee:
- Deterministic costing
- No "NULL cost bucket" during rollups
- Safe export/report behavior

### 4.2 Nature of System Default
- Logical default, not necessarily a DB row
- Typically resolved as:
  - A configured CostHead (e.g., `UNCLASSIFIED`)
  - Or a fixed internal enum mapping

### 4.3 Governance Rules (LOCKED)

| Rule | Status |
|------|--------|
| Only used if both overrides are NULL | ‚úÖ |
| Must be deterministic | ‚úÖ |
| Must be tenant-safe | ‚úÖ |
| Must be documented | ‚úÖ |

‚∏ª

## 5) A6 CostHead Resolution Algorithm (Authoritative)

### 5.1 Deterministic Resolution Order (LOCKED)

```
IF quote_bom_items.cost_head_id IS NOT NULL
    USE quote_bom_items.cost_head_id
ELSE IF products.cost_head_id IS NOT NULL
    USE products.cost_head_id
ELSE
    USE SYSTEM_DEFAULT_COST_HEAD
```

### 5.2 Execution Layer
- **Primary enforcement:** Service / Domain layer
- **Schema role:** Referential integrity only
- **Compute layer:** Uses resolved CostHead for aggregation only

‚∏ª

## 6) Runtime Mutation & Safety Rules

### 6.1 Apply-Recalc Interaction
- Apply-Recalc does not change CostHead assignments
- CostHead is not snapshotted (it is resolved dynamically)

### 6.2 Failure Handling

| Failure | Behavior |
|---------|----------|
| Invalid cost_head_id | Reject (4xx) |
| Deleted CostHead | SET NULL ‚Üí fallback resolution |
| Missing product | Skip product default |

**No silent failure is allowed.**

‚∏ª

## 7) Audit Expectations (A6-Specific)

### 7.1 Mandatory Audit Events (Recommended but Not Hard-Blocking)

| Event | When |
|-------|------|
| `COSTHEAD_OVERRIDE_SET` | Line override changed |
| `COSTHEAD_OVERRIDE_REMOVED` | Override cleared |
| `COSTHEAD_MASTER_UPDATE` | CostHead master changed |

These are classification events, not pricing events ‚Äî but still audit-relevant.

‚∏ª

## 8) Explicit Non-Goals (LOCKED)
- ‚ùå No automatic CostHead propagation
- ‚ùå No CostHead inheritance across hierarchy
- ‚ùå No CostHead-based price rules
- ‚ùå No schema CHECK constraints enforcing precedence
- ‚ùå No CostHead locking in MVP

‚∏ª

## 9) A6 Closure Criteria (Freeze-Gate)

A6.1‚ÄìA6.4 are considered CLOSED when:
- Schema existence is verified (A6.1, A6.2)
- Precedence is explicitly locked (this document)
- Data Dictionary references this governance
- No contradiction exists with A5 or A7

‚∏ª

## References

- A6.1 Schema Verification: `A6.1_Verify_cost_heads_table_exists.md`
- A6.2 Schema Verification: `A6.2_Verify_quote_bom_items_cost_head_id.md`
- A6.3 Decision: `A6.3_Decision_Products_CostHead_Default.md`
- A6.4 Schema Verification: `A6.4_Verify_products_cost_head_id.md`
- A5 IsLocked Scope: `../A5_IsLocked_Scope/`
- A7 Runtime Enforcement: `../A7_Post_Schema_Governance_Controls/`

