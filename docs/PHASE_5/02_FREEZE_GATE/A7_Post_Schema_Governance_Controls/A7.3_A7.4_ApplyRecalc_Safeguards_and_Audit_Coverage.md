# A7.3 + A7.4 ‚Äî Apply-Recalc Safeguards & Audit Coverage Matrix (Freeze-Gate Spec)

**Phase:** Phase-5  
**Category:** A ‚Äî Governance & Runtime Controls  
**Item:** A7.3 (Apply-Recalc safeguards) + A7.4 (Audit coverage matrix)  
**Status:** ‚úÖ READY (Documentation-only, Freeze-Gate)  
**Date:** 2026-01-27  
**Owner:** Phase-5 Senate  
**Purpose:** Define authoritative runtime governance for any operation that changes money fields, guaranteeing deterministic computation, explicit approval, tenant safety, and audit-ready traceability.

‚∏ª

## 0Ô∏è‚É£ Scope & Non-Goals

### In-Scope
- Money mutation governance for quotation pricing totals and tax snapshots
- Apply-Recalc contract (Policy-1) ‚Äî authorization, atomicity, audit
- Discount mutation governance ‚Äî what can be changed, by whom, when
- Rate override governance ‚Äî role gates + reason + traceability
- Locking interaction ‚Äî align to A5 scope (delete-only in MVP)
- CostHead precedence alignment ‚Äî align to A6 precedence rules

### Not In-Scope (explicit)
- UI workflow, screen design, or operator UX wording
- Adding new DB columns / migrations
- Adding new business decisions (this doc codifies existing locked decisions)
- Cross-tenant bulk operations (strictly forbidden)

‚∏ª

## 1Ô∏è‚É£ Canonical Terms

### "Compute" vs "Persist"
- **Compute:** pure deterministic calculation; returns computed values; no database writes
- **Persist:** saves computed values into snapshot columns or line-level fields; database writes occur

### "Snapshot"
- Snapshot fields are not authoritative until Apply-Recalc occurs (Policy-1).
- Snapshot fields are authoritative only for:
  - audit-ready totals
  - downstream exports / approvals
  - historical comparability

‚∏ª

## 2Ô∏è‚É£ Canonical Actions Set (LOCKED vocabulary)

These actions are system-level "verbs". If a future endpoint exists, it must map cleanly to one verb.

| Action | Definition | DB write? | Money impact? | Audit required? |
|--------|------------|-----------|---------------|-----------------|
| PRICING_PREVIEW | Compute totals for quotation; return results | ‚ùå | ‚úÖ (computed only) | Optional |
| APPLY_RECALC | Compute + persist quotation snapshot fields | ‚úÖ | ‚úÖ | ‚úÖ Required |
| RATE_OVERRIDE_SET | Persist manual override rate fields | ‚úÖ | ‚úÖ | ‚úÖ Required |
| DISCOUNT_RULE_SET / UPDATE / DEACTIVATE | Persist discount rule changes | ‚úÖ | ‚úÖ (future apply) | ‚úÖ Required |
| LINE_DISCOUNT_OVERRIDE_SET | Persist line override discount marker/pct | ‚úÖ | ‚úÖ | ‚úÖ Required |
| QUOTATION_DISCOUNT_SET | Persist quotation-level discount pct | ‚úÖ | ‚úÖ | ‚úÖ Required |
| LINE_ITEM_DELETE_ATTEMPT | Attempt deletion | ‚úÖ/‚ùå (depends) | Indirect | ‚úÖ Required (at least on denial) |

**Governance note:** "Money impact" includes changes that affect pricing computation even if totals aren't immediately recalculated.

‚∏ª

## 3Ô∏è‚É£ Authority & Permissions (Governance Gate)

### Role Classes (logical, not implementation-bound)
- **Operator:** allowed to configure bulk/structural commercial parameters (except sensitive overrides)
- **Reviewer / Approver:** allowed to approve/commit computation (Apply-Recalc) and sensitive overrides
- **Admin:** system-level; can do everything but still must obey Policy-1 rules

### Minimum Permission Gate Table (LOCKED)

| Operation | Operator | Reviewer | Approver | Admin | Notes |
|-----------|----------|----------|----------|-------|-------|
| Preview | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Must be tenant-safe |
| Apply-Recalc | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | Requires decision_id + reason |
| Rate override (manual) | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | Requires reason + audit |
| Set quotation discount % | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Range 0..100 |
| Set site/make/category discount rules | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Rule-upsert semantics |
| Set line discount override | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | "Sensitive" override |
| Delete line item | ‚úÖ* | ‚úÖ* | ‚úÖ* | ‚úÖ* | *Blocked when is_locked=true |

**No role bypass:** even Admin cannot silently persist totals without an Apply-Recalc action that is audited.

‚∏ª

## 4Ô∏è‚É£ Policy-1 Contract (Preview vs Apply)

### Policy-1 Invariants (non-negotiable)
1. Preview never writes to any money field, snapshot field, or audit row.
2. Apply-Recalc is explicit: request must include:
   - `decision_id` (string/idempotency token)
   - `reason` (human rationale)
3. Apply-Recalc is role-restricted (Reviewer/Approver/Admin).
4. Apply-Recalc uses the same compute logic as preview (single source of truth).
5. Rowcount verification required for critical updates (anti-silent-failure).

### Apply-Recalc Writes Are Limited To:
- Quotation snapshot fields (see Section 6)
- (Optional) line-level computed fields if your architecture persists those (rate/net_rate/amount), but still must be within the transaction and audited.

‚∏ª

## 5Ô∏è‚É£ Locking Interaction Rules (A5 Alignment)

### A5 Locked Scope Reminder
- `is_locked` exists only on `quote_bom_items` (MVP).
- MVP meaning: prevents deletion only.

### Locking Governance Rules (LOCKED)
1. `is_locked = true` blocks DELETE_LINE_ITEM
2. `is_locked = true` does NOT block:
   - Apply-Recalc
   - Rate overrides
   - Discount rules
   - Resolve L0/L1‚ÜíL2
   - Repricing

**Rationale:** MVP lock is a structural safety device, not a workflow freeze.

‚∏ª

## 6Ô∏è‚É£ Quotation Commercial + Tax Fields ‚Äî Authoritative Mutation Rules

### 6.1 Inputs / Selections (can change anytime with permissions)
- `quotations.discount_pct`
- `quotations.tax_profile_id`
- `quotations.tax_mode`

These are configuration fields.

### 6.2 Snapshot Fields (Apply-Recalc only)

Written only on Apply-Recalc (Policy-1), and only as part of the Apply-Recalc transaction:
- `quotations.taxable_base`
- `quotations.cgst_pct_snapshot`, `quotations.sgst_pct_snapshot`, `quotations.igst_pct_snapshot`
- `quotations.cgst_amount`, `quotations.sgst_amount`, `quotations.igst_amount`
- `quotations.tax_amount_total`
- `quotations.grand_total`

### 6.3 Snapshot Authority Rule (governance)
- **Before Apply-Recalc:** snapshot fields may be NULL/0/old values; they are not authoritative
- **After Apply-Recalc:** snapshot fields become authoritative for:
  - financial exports
  - approvals
  - audit references
  - downstream reports

### 6.4 Tax Selection Rule (determinism)
- If tax is enabled, `tax_mode` must be one of: CGST_SGST or IGST
- Tax profiles must be tenant-safe and active

‚∏ª

## 7Ô∏è‚É£ CostHead Precedence Governance (A6 Alignment)

### A6 Locked Precedence
`quote_bom_items.cost_head_id` ‚Üí `products.cost_head_id` ‚Üí system default

### Mutation Rules
- Changing `cost_head_id` on a line is allowed (tenant-safe + audited if you treat it as financial classification change).
- Deleting a cost head must be safe (FK typically SET NULL), preserving integrity.

‚∏ª

## 8Ô∏è‚É£ Apply-Recalc Execution Flow (Technical Contract)

### 8.1 Required Transaction Boundaries

Apply-Recalc must execute inside a single DB transaction:
1. Load quotation (tenant-safe)
2. Compute using single source of truth compute helper
3. Persist snapshot fields
4. Persist audit row
5. Commit transaction

**If any step fails ‚Üí rollback entire transaction.**

### 8.2 Rowcount Verification (hard rule)
- Snapshot update must verify exactly 1 row updated for quotations:
  - If rowcount != 1 ‚Üí treat as failure (409) and rollback
- Discount rule upserts should also rowcount-check.

### 8.3 Deterministic Math
- Percent quantization: 2dp
- Amount quantization: 4dp (or per your system standard)
- No float arithmetic

‚∏ª

## 9Ô∏è‚É£ Audit Coverage Matrix (A7.4)

### 9.1 Mandatory Audit Events (must exist)

| Event | When emitted | Resource type / id |
|-------|--------------|-------------------|
| APPLY_RECALC | every successful Apply-Recalc | quotation / quotation_id |
| RATE_OVERRIDE_SET | whenever override_rate stored | quote_bom_item / line_id |
| QUOTATION_DISCOUNT_SET | quotation discount changed | quotation / quotation_id |
| DISCOUNT_RULE_SET | new rule created | discount_rule / rule_id |
| DISCOUNT_RULE_UPDATE | existing rule updated | discount_rule / rule_id |
| DISCOUNT_RULE_DEACTIVATE | rule deactivated | discount_rule / rule_id |
| LINE_DISCOUNT_OVERRIDE_SET | line discount override applied | quote_bom_item / line_id |

### 9.2 Deletion Attempt Audit (governance requirement)
- If delete is rejected because `is_locked=true`, emit:
  - `LINE_ITEM_DELETE_ATTEMPT` with outcome "DENIED_LOCKED"
- If delete succeeds, emit:
  - `LINE_ITEM_DELETE` with outcome "SUCCESS"

This is critical for dispute defense ("who tried to delete what").

### 9.3 Required Audit Payload (minimum fields)

Each audit record must include:
- `tenant_id`
- `actor_id` (user_id)
- `action_type` (string)
- `resource_type`
- `resource_id`
- `old_values` (JSON)
- `new_values` (JSON)
- `metadata` (JSON) including:
  - `quotation_id` (where relevant)
  - `decision_id` (for Apply-Recalc)
  - `reason` (for sensitive changes)
  - `actor_roles` (optional but useful)
- `created_at`

### 9.4 Audit Write Discipline (hard rule)
- All modules write audits only via AuditLogger (or AUDIT API)
- Audit row must be written within the same transaction as the change it describes
- No "audit later" background writing for money mutations

‚∏ª

## üîü Failure Handling & Recovery (Audit-Safe)

### 10.1 Failure Classes

| Failure | Behavior |
|---------|----------|
| Validation failure (role/reason/range) | Reject request (4xx), no DB writes |
| Compute failure (data inconsistent) | Reject (4xx/5xx), no partial writes |
| Snapshot persistence fails | rollback; reject (409/500) |
| Audit persistence fails | rollback; reject (500) |

### 10.2 Idempotency Recommendation (Apply-Recalc)
- Treat `decision_id` as an idempotency token:
  - If the same `decision_id` is replayed, system may return "already applied" (optional)
- If idempotency is not implemented, still store `decision_id` in audit for traceability.

‚∏ª

## 1Ô∏è‚É£1Ô∏è‚É£ Compliance Tests (What Must Exist to Claim Compliance)

Minimum tests expected:
- Apply-Recalc permission checks (Reviewer/Approver only)
- Apply-Recalc requires decision_id + reason
- Preview does not write snapshot fields
- Apply-Recalc updates snapshot fields and audit emits event
- Locked item deletion denied
- G-06 fixed-no-discount enforced (discount_pct forced 0 at schema + compute)
- UNRESOLVED normalization safe behavior (no garbage totals)

‚∏ª

## 1Ô∏è‚É£2Ô∏è‚É£ Closure Criteria (A7.3‚ÄìA7.4)

A7.3‚ÄìA7.4 are complete when:
- This spec is stored in freeze-gate folder
- References are added to checklist (A7.6 later)
- Data Dictionary gets a short note referencing these governance rules (A7.7 later)
- No contradictions with A1‚ÄìA6

‚∏ª

## A7.3 + A7.4 Conclusion

- Zero schema impact
- Fully aligned with A5 + A6 + Policy-1
- Comprehensive audit coverage defined
- Safe for parallel execution with Schema Design

**Status:** ‚úÖ READY TO EXECUTE

‚∏ª

## Next: A7.5 ‚Äî Failure & Recovery Semantics

