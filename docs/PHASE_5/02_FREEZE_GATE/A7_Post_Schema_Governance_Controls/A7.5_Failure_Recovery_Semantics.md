# A7.5 ‚Äî Failure & Recovery Semantics (Freeze-Gate Spec)

**Phase:** Phase-5  
**Category:** A ‚Äî Governance & Runtime Controls  
**Item:** A7.5  
**Status:** üü¢ READY (Documentation-only)  
**Date:** 2026-01-27  
**Purpose:** Define authoritative failure handling, recovery rules, and safe fallbacks for all runtime operations, ensuring no silent corruption and predictable operator behavior.

‚∏ª

## 1Ô∏è‚É£ Failure Classes (Canonical)

| Failure Class | Definition | Recovery Strategy |
|---------------|------------|-------------------|
| Validation Failure | Invalid input, role/permission violation, range violation | Reject request (4xx), no DB writes |
| Data Inconsistency | Missing required master data, orphaned references | Reject request (4xx/5xx), no partial writes |
| Compute Failure | Pricing calculation error, tax computation error | Reject request (4xx/5xx), no partial writes |
| Persistence Failure | DB write failure, constraint violation | Rollback transaction, reject (409/500) |
| External Dependency Failure | AI service unavailable, pricing service timeout | Fallback to safe defaults, continue operation |
| Audit Failure | Audit write fails during transaction | Rollback entire transaction, reject (500) |

‚∏ª

## 2Ô∏è‚É£ Pricing Lookup Failures (LOCKED)

### Scenario: Price Not Found

**Rule:** Missing pricing data must not block quotation creation or Apply-Recalc.

**Behavior:**
- Use `is_price_missing = true` marker (per G-03)
- Set `amount = 0` (per G-03 normalization)
- Continue processing other line items
- Return computed totals with missing price indicators
- UI must surface missing prices clearly

**No Silent Corruption:**
- Never insert NULL or garbage values
- Never skip line item processing
- Never default to arbitrary prices

‚∏ª

### Scenario: Pricing Service Unavailable

**Rule:** External pricing service failures must not block core estimation workflows.

**Behavior:**
- Fallback to cached/last-known prices if available
- If no cache: mark `is_price_missing = true`, set `amount = 0`
- Log service failure to audit/error logs
- Operator receives clear notification
- Operation completes (no partial failure)

**Recovery:**
- Operator can retry pricing resolution later
- No transaction rollback required (pricing is advisory during estimation)

‚∏ª

## 3Ô∏è‚É£ CostHead Resolution Failures (A6 Alignment)

### Scenario: CostHead Missing

**Rule:** Missing CostHead must not block quotation processing.

**Behavior:**
- Apply A6 precedence: `quote_bom_items.cost_head_id` ‚Üí `products.cost_head_id` ‚Üí system default
- If all levels fail: allow `cost_head_id = NULL`
- Continue processing
- UI surfaces missing CostHead warnings
- Reporting/rollups handle NULL gracefully

**No Silent Corruption:**
- Never assign arbitrary CostHead
- Never skip line item processing
- Log CostHead resolution failures for operator review

‚∏ª

### Scenario: CostHead Deleted

**Rule:** FK constraint handles deletion (typically SET NULL).

**Behavior:**
- FK constraint sets `cost_head_id = NULL` (per schema)
- Re-apply A6 precedence on next resolution
- No data corruption
- No transaction failure (FK handles gracefully)

‚∏ª

## 4Ô∏è‚É£ AI Service Failures (G-06 Alignment)

### Scenario: AI/RAG Service Unavailable

**Rule:** AI failures must never block estimation (per G-06: RAG is advisory only).

**Behavior:**
- Continue estimation without AI suggestions
- Mark AI suggestions as unavailable
- No transaction failure
- No partial writes
- Operator receives notification (non-blocking)

**Recovery:**
- Operator can retry AI suggestions later (explicit action)
- AI suggestions are applied only when user explicitly approves (audited)

‚∏ª

## 5Ô∏è‚É£ Apply-Recalc Failure Semantics (Policy-1 Alignment)

### Transaction Atomicity (LOCKED)

**Rule:** Apply-Recalc is all-or-nothing.

**Failure Points:**
1. **Before compute:** Validation failure ‚Üí reject (4xx), no DB writes
2. **During compute:** Computation error ‚Üí reject (4xx/5xx), no DB writes
3. **After compute, before persist:** Persistence failure ‚Üí rollback, reject (409/500)
4. **After persist, before audit:** Audit failure ‚Üí rollback, reject (500)

**Invariant:** If any step fails, entire transaction rolls back. No partial snapshot updates.

‚∏ª

### Rowcount Verification Failure

**Rule:** Snapshot update must verify exactly 1 row updated.

**Behavior:**
- If rowcount != 1 ‚Üí treat as failure (409 Conflict)
- Rollback transaction
- Return error: "Quotation state changed during operation"
- Operator can retry after refreshing state

**No Silent Corruption:**
- Never accept rowcount = 0 (quotation deleted/missing)
- Never accept rowcount > 1 (data corruption/invariant violation)

‚∏ª

## 6Ô∏è‚É£ Idempotency Rules (Apply-Recalc)

### Decision ID as Idempotency Token (Recommended)

**Rule:** `decision_id` can be used as idempotency token.

**Behavior (if implemented):**
- If `decision_id` already exists in audit log ‚Üí return "already applied" response
- Return previous result (no re-computation)
- No error, no duplicate processing

**Behavior (if not implemented):**
- Process request normally
- `decision_id` stored in audit for traceability
- Multiple requests with same `decision_id` may result in multiple applies (operator responsibility to avoid)

**Governance Note:** Idempotency is recommended but not required in MVP.

‚∏ª

## 7Ô∏è‚É£ Retry Rules (Operator Guidance)

### Retryable Failures

| Failure Type | Retryable? | Operator Action |
|--------------|------------|-----------------|
| Pricing service timeout | ‚úÖ Yes | Retry pricing resolution |
| External dependency timeout | ‚úÖ Yes | Retry operation |
| Database connection error | ‚úÖ Yes | Retry operation |
| Validation failure | ‚ùå No | Fix input, resubmit |
| Permission denied | ‚ùå No | Request proper role |
| Data inconsistency | ‚ùå No | Fix data, resubmit |
| Transaction conflict (409) | ‚úÖ Yes | Refresh state, retry |

‚∏ª

### Retry Guidance (LOCKED)

**Rule:** Operators should retry only for transient failures.

**Best Practices:**
- Maximum 3 retries for transient failures
- Exponential backoff recommended (1s, 2s, 4s)
- Do not retry validation/permission failures
- Always refresh state before retry after 409 Conflict

‚∏ª

## 8Ô∏è‚É£ Safe Fallbacks (No Silent Corruption)

### Core Principle (LOCKED)

**Rule:** All failures must either:
1. Reject operation cleanly (with clear error message), OR
2. Continue with explicit safe defaults (marked clearly)

**Forbidden:**
- ‚ùå Silent NULL insertion
- ‚ùå Arbitrary default values
- ‚ùå Partial writes without rollback
- ‚ùå Skipping validation checks
- ‚ùå Garbage data persistence

‚∏ª

### Safe Default Values (LOCKED)

| Field | Safe Default | Marker Required |
|-------|--------------|-----------------|
| Missing price | `amount = 0` | `is_price_missing = true` |
| Missing CostHead | `cost_head_id = NULL` | Warning in UI |
| Missing tax profile | Use quotation default or NULL | Warning in UI |
| Compute error | Reject operation | N/A (no partial write) |

‚∏ª

## 9Ô∏è‚É£ Error Response Contract (Operator-Facing)

### Standard Error Response Format

**Structure:**
```json
{
  "success": false,
  "error_code": "APPLY_RECALC_FAILED",
  "message": "Human-readable error message",
  "details": {
    "failure_class": "Persistence Failure",
    "failure_point": "audit_write",
    "transaction_rolled_back": true,
    "can_retry": false
  }
}
```

### Error Codes (Canonical Set)

| Error Code | HTTP Status | Retryable? | Meaning |
|------------|-------------|------------|---------|
| VALIDATION_FAILED | 400 | ‚ùå | Invalid input |
| PERMISSION_DENIED | 403 | ‚ùå | Insufficient role |
| RESOURCE_NOT_FOUND | 404 | ‚ùå | Quotation/line item not found |
| CONFLICT | 409 | ‚úÖ | State changed, refresh and retry |
| COMPUTE_ERROR | 422 | ‚ùå | Calculation failed |
| PERSISTENCE_ERROR | 500 | ‚ùå | Database error |
| AUDIT_FAILED | 500 | ‚ùå | Audit write failed (transaction rolled back) |
| EXTERNAL_SERVICE_UNAVAILABLE | 503 | ‚úÖ | Pricing/AI service down |

‚∏ª

## üîü Operator Guidance Summary

### Before Apply-Recalc
- Ensure quotation state is stable (no concurrent edits)
- Verify pricing data availability (preview shows no critical missing prices)
- Confirm proper role/permissions

### After Apply-Recalc Failure
1. Check error code and message
2. If 409 Conflict: refresh quotation, review changes, retry
3. If validation/permission error: fix issue, do not retry
4. If compute error: review data consistency, fix, resubmit
5. If persistence error: contact support (potential system issue)

### Recovery Procedures
- **Missing prices:** Resolve pricing data, retry pricing resolution, then Apply-Recalc
- **Missing CostHead:** Assign CostHead, then Apply-Recalc
- **AI unavailable:** Continue without AI, apply suggestions later if needed
- **Transaction conflicts:** Refresh state, retry Apply-Recalc

‚∏ª

## 1Ô∏è‚É£1Ô∏è‚É£ A7.5 Conclusion

- All failure scenarios have defined behavior
- No silent corruption possible
- Clear operator guidance for all failure modes
- Safe fallbacks explicitly defined
- Fully aligned with A5, A6, G-03, G-06, Policy-1

**Status:** üü¢ READY TO EXECUTE

‚∏ª

## Next: A7.6 ‚Äî Update Checklist & Data Dictionary

