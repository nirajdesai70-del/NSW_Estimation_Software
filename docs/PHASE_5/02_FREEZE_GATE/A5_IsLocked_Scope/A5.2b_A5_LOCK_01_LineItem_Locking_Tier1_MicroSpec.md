# A5-LOCK-01 ‚Äî Line-Item Locking (Delete-Only, MVP) (Tier-1 Micro-Spec)

> **‚ö†Ô∏è IMPORTANT: This is an ADDITIVE enhancement to A5.1‚ÄìA5.6, not a replacement.**  
> Primary references remain:
> - `A5.1_Review_IsLocked_Field_Coverage.md`
> - `A5.2_IsLocked_Scope_Decision.md`
> - `A5.3‚ÄìA5.6` (absence proofs + checklist/data dictionary closure)
> 
> This micro-spec provides Tier-1 depth for runtime guardrails, audit expectations, failure/recovery semantics, and future extension control.

**Phase:** Phase-5  
**Category:** A ‚Äî Governance / Runtime Control (Tier-1)  
**Rule ID:** A5-LOCK-01  
**Status:** üîí LOCKED  
**Date:** 2026-01-27  
**Template:** Tier-1 Micro-Spec Template v1.0  
**Primary References:** A5.1‚ÄìA5.6 (Freeze-Gate Verified)

‚∏ª

## 1Ô∏è‚É£ Rule Identifier

- **Rule ID:** A5-LOCK-01
- **Category:** Governance / Runtime Control / Audit-Defensibility
- **Phase Introduced:** Phase-5
- **Risk Class:** üî¥ Tier-1 (Audit / Legal / Operational Integrity)

‚∏ª

## 2Ô∏è‚É£ Intent (What This Rule Protects)

**Protection:** Prevent accidental or unauthorized deletion of commercially significant quotation line items by enforcing a single authoritative lock flag at line level: `quote_bom_items.is_locked`.

**If Violated:**
- Loss of critical line items (irreversible commercial impact)
- Post-review changes without traceability
- Governance failure ("why was this deleted?" cannot be answered)
- Quotation integrity compromised (totals, tax snapshots, audit trail become inconsistent)

**Why Beyond Schema:** Schema only stores the flag. The runtime must decide when delete is allowed, how the error is returned, and how audit must capture attempts and outcomes.

‚∏ª

## 3Ô∏è‚É£ Business Rationale (Why This Must Exist)

### Financial Risk Prevented
- **Deleting material lines changes totals, margin, tax base, and customer commitments:** Loss of line items directly impacts quotation financials and customer deliverables

### Audit / Legal Risk Prevented
- **Deletion without traceability is non-defensible:** Cannot prove who deleted what, when, or why
- **Lock is the simplest "governance fence" to prevent accidental loss:** Provides clear, auditable protection mechanism

### User-Behavior Risk Prevented
- **Estimators may delete lines during cleanup:** Without lock, critical lines may be accidentally removed
- **Reviewers need assurance critical lines can't vanish:** Lock provides explicit protection after review
- **Without explicit rules, future developers may treat is_locked as "UI only":** Runtime enforcement prevents this misinterpretation

### Why "Common Sense" Is Not Sufficient
- **Deletion can happen via UI, API, import tools, scripts:** Multiple entry points require consistent enforcement
- **Without a single enforced rule, the behavior diverges across endpoints:** Centralized enforcement ensures consistency

‚∏ª

## 4Ô∏è‚É£ Canonical Scope (Where It Applies)

| Dimension | Applies | Notes |
|-----------|---------|-------|
| Schema | ‚úÖ | Column exists on `quote_bom_items` only; higher levels explicitly absent (MVP) |
| Service Layer | ‚úÖ | **Primary enforcement** ‚Äî delete must check `is_locked` |
| Compute / Engine | ‚ùå | Lock does not change math (MVP) |
| API / Validator | ‚úÖ | Should reject delete early with stable error code/message |
| Audit | ‚ö†Ô∏è | Recommended minimum now; mandatory when lock/unlock endpoints go live |
| UI | ‚ùå | UI may disable buttons; not authoritative |

‚∏ª

## 5Ô∏è‚É£ Schema Behavior (Hard Guarantees)

### 5.1 Presence (Authoritative)

**Table:** `quote_bom_items`  
**Column:** `is_locked`

- **Type:** `BOOLEAN`
- **NOT NULL:** Yes
- **Default:** `server_default='false'` (migration line 439)
- **Index:** `idx_quote_bom_items_is_locked` (non-unique, for filtering locked items)

**Evidence:**
- **Migration:** `backend/alembic/versions/20260104_110400_create_schema_canon_v1_0_l1_l2_quo_pricing.py`
- **Line 439:** `sa.Column('is_locked', sa.Boolean(), nullable=False, server_default='false')`
- **Line 484:** `op.create_index('idx_quote_bom_items_is_locked', 'quote_bom_items', ['is_locked'], unique=False)`
- **A5.1 Verification:** `A5.1_Review_IsLocked_Field_Coverage.md` (verified present)

### 5.2 Explicit Absences (Critical, MVP Scope)

**These are part of the rule (must remain absent unless Senate approves extension):**

- ‚ùå `quotations.is_locked` ‚Äî Absent (verified: A5.5)
- ‚ùå `quote_panels.is_locked` ‚Äî Absent (verified: A5.3)
- ‚ùå `quote_boms.is_locked` ‚Äî Absent (verified: A5.4)

**Evidence:**
- **A5.3:** `A5.3_Verify_quote_panels_is_locked_absent.md`
- **A5.4:** `A5.4_Verify_quote_boms_is_locked_absent.md`
- **A5.5:** `A5.5_Verify_quotations_is_locked_absent.md`

**Rationale:** MVP scope is line-item only. Higher-level locking requires explicit governance decision.

### 5.3 Constraint Absences (Intentional)

- ‚ùå **No DB CHECK constraint blocks delete**

**Rationale:** Delete control is runtime policy, not schema. Schema stores the flag; service layer enforces the policy.

‚∏ª

## 6Ô∏è‚É£ Runtime Enforcement Semantics (Authoritative)

### 6.1 Allowed States

#### State A ‚Äî Unlocked Line Item

- `is_locked = false`
- **Delete:** ‚úÖ Allowed (subject to any other deletion policies if/when introduced)

#### State B ‚Äî Locked Line Item

- `is_locked = true`
- **Delete:** ‚ùå Blocked (always, MVP)

### 6.2 Blocked States

#### Blocked State 1 ‚Äî Delete Locked Item

- **Operation:** `DELETE_LINE_ITEM` on a row where `is_locked = true`
- **Outcome:** Hard reject at service layer (stable error contract)

### 6.3 When Enforcement Happens

| Event | Enforcement | Required Behavior |
|-------|-------------|-------------------|
| **Create line item** | ‚Äî | Default lock state is `false` unless explicitly set by system/authorized actor |
| **Update line item** | ‚Äî | MVP does not restrict edits. Lock does not block mutation (rate, quantity, description, resolution, repricing) |
| **Delete line item** | ‚úÖ Service/API | **Must check `is_locked` before delete and block if `true`** |
| **Preview** | ‚Äî | No impact (lock does not affect compute) |
| **Apply-Recalc** | ‚Äî | Allowed even if locked (MVP). Lock only protects deletion |

‚∏ª

## 7Ô∏è‚É£ Compute / Engine Semantics

### MVP Lock Rule: Lock Does NOT Change Totals

**Required Behavior:**
- **No special handling required in compute path:** Lock does not affect calculation logic
- **Apply-recalc can persist pricing/tax snapshots regardless of lock state:** Lock is not a "freeze pricing" mechanism in MVP

**Formula (Unchanged):**
```
line_amount = rate √ó quantity √ó (1 - discount_pct/100)
quotation_total = SUM(line_amount) for all items
```

**Lock state does NOT affect these calculations.**

### Non-Goal Explicitly

**Lock is NOT a "freeze pricing" mechanism in MVP:**  
Lock only prevents deletion. Edits, repricing, resolution are all allowed even when locked.

‚∏ª

## 8Ô∏è‚É£ Audit & Traceability Expectations

### 8.1 Minimum (Recommended Now)

**Even if full lock/unlock lifecycle is not implemented, delete-blocked attempts should be auditable to defend governance.**

#### Recommended Event: DELETE_BLOCKED_LOCKED_ITEM

**Event Type:** `DELETE_BLOCKED_LOCKED_ITEM`

**Minimum Fields:**
- `tenant_id` (BIGINT)
- `user_id` (BIGINT) ‚Äî User who attempted delete
- `resource_type = 'quote_bom_item'`
- `resource_id = <line_item_id>`
- `action = 'DELETE_BLOCKED_LOCKED_ITEM'`
- `timestamp` (TIMESTAMP)

**Minimum Metadata:**
```json
{
  "is_locked": true,
  "reason": "Line item is locked (MVP delete-only lock)"
}
```

**Enforcement:** Recommended (not mandatory in MVP, but highly recommended for audit defensibility)

### 8.2 Mandatory (When Lock/Unlock Endpoints Exist)

**When explicit lock/unlock actions are implemented, audit becomes mandatory:**

#### Event 1 ‚Äî LOCK_APPLIED

**Event Type:** `LOCK_APPLIED`

**Required Fields:**
- `tenant_id`, `user_id`
- `resource_type = 'quote_bom_item'`, `resource_id = <line_item_id>`
- `action = 'LOCK_APPLIED'`
- `timestamp`

**Required Metadata:**
```json
{
  "previous_state": false,
  "new_state": true,
  "lock_reason": "<optional_reason_if_captured>"
}
```

**Enforcement:** Mandatory (when lock endpoint exists)

#### Event 2 ‚Äî UNLOCK_APPLIED

**Event Type:** `UNLOCK_APPLIED`

**Required Fields:**
- `tenant_id`, `user_id`
- `resource_type = 'quote_bom_item'`, `resource_id = <line_item_id>`
- `action = 'UNLOCK_APPLIED'`
- `timestamp`

**Required Metadata:**
```json
{
  "previous_state": true,
  "new_state": false,
  "unlock_reason": "<optional_reason_if_captured>"
}
```

**Enforcement:** Mandatory (when unlock endpoint exists)

#### Event 3 ‚Äî DELETE_ALLOWED (Optional)

**Event Type:** `DELETE_ALLOWED` (optional, depends on audit policy)

**When:** Logged after successful delete of unlocked item (if audit policy requires)

**Enforcement:** Optional (depends on overall deletion audit policy)

‚∏ª

## 9Ô∏è‚É£ Explicit Non-Goals (VERY IMPORTANT)

### Does NOT Block Edits in MVP

**Non-Goal:** Lock does NOT prevent edits (rate, quantity, description, resolution, repricing).

**Clarification:** Lock only prevents deletion. All other mutations are allowed even when `is_locked = true`.

### Does NOT Propagate Lock to Parent BOM/Panel/Quotation

**Non-Goal:** Lock does NOT cascade or propagate to parent levels.

**Clarification:** Line-item lock is independent. Locking a line does not lock the BOM, panel, or quotation that contains it.

### Does NOT Use `quotations.status` as Substitute for Locking

**Non-Goal:** Lock does NOT rely on workflow status fields.

**Clarification:** `quotations.status` (DRAFT, APPROVED, FINALIZED, CANCELLED) is workflow state, not locking mechanism. Lock is schema-level explicit flag, not derived from status.

### Does NOT Force Audit Storage Changes Today

**Non-Goal:** Lock does NOT require new audit storage infrastructure in MVP.

**Clarification:** Recommended to log delete-blocked events, but not mandatory until lock/unlock endpoints exist.

### Does NOT Define "Who Can Lock/Unlock" Until Lock/Unlock Endpoints Exist

**Non-Goal:** Lock does NOT define authorization rules in MVP.

**Clarification:** Authorization (who can lock/unlock) is kept as controlled future extension. MVP focuses on delete protection only.

‚∏ª

## üîü Failure & Recovery Semantics

### Failure Mode: Delete Attempted on Locked Line Item

**Trigger:** DELETE request when `is_locked = true`

**Response (Recommended Contract):**
- **HTTP Status:** 409 Conflict (or 403 Forbidden if you prefer "permission-style"; pick one and keep stable)
- **Error Code:** `LINE_ITEM_LOCKED`
- **Message:** "Item is locked and cannot be deleted"

**Recovery Options:**
- **If the item should be deletable:** An authorized actor must unlock (future) OR clone and delete unlocked copy (workflow)
- **Until unlock feature exists:** Recovery is manual via admin process (direct DB update, with audit trail)

**Who Can Recover:** Authorized admin (when unlock feature exists) or admin with DB access (manual recovery)

### Failure Mode: Inconsistent UI Behavior

**Trigger:** UI allows clicking delete button, but backend blocks due to lock

**Response:**
- **Backend is authoritative:** Backend rejection takes precedence
- **UI should align:** UI should disable delete button when `is_locked = true` (but this is not authoritative enforcement)

**Recovery:**
- **Immediate:** Backend blocks delete (correct behavior)
- **UI Fix:** Update UI to disable delete button for locked items (non-blocking, UX improvement)

**Who Can Recover:** UI developer (align UI with backend behavior)

‚∏ª

## 1Ô∏è‚É£1Ô∏è‚É£ Future Extension Rules (Controlled)

### Extension A ‚Äî Add Lock at BOM/Panel/Quotation Levels

**What Could Be Extended:**
- Add `is_locked` column to `quote_boms`, `quote_panels`, `quotations` tables
- Implement lock propagation semantics (e.g., "panel locked ‚Üí all items locked")

**What MUST Happen Before Extension:**
1. **Decision:** Senate approval (explicit decision on lock propagation rules)
2. **Schema:** Migration adding columns + indexes
3. **Runtime:** Lock propagation semantics (lock precedence rules, cascade behavior)
4. **Audit:** Update audit events to capture higher-level locks
5. **Doc Update:** This micro-spec updated (add higher-level states to Section 6.1, update scope in Section 5.2)
6. **Data Dictionary:** Update locking policy documentation
7. **Freeze Checklist:** Update checklist to reflect new scope
8. **Tests:** Comprehensive tests for propagation behavior

**Change Control:** Must follow Phase-5 Freeze-Gate process (or Phase-6 equivalent)

### Extension B ‚Äî Lock Blocks Edits/Reprice/Resolve

**What Could Be Extended:**
- Lock prevents edits (rate, quantity, description)
- Lock prevents repricing (apply-recalc blocked)
- Lock prevents resolution (L0/L1 ‚Üí L2 blocked)

**What MUST Happen Before Extension:**
1. **Decision:** Governance approval (explicit policy update)
2. **Schema:** No schema changes needed (flag already exists)
3. **Runtime:** Update mutation endpoints to check lock state
4. **Doc Update:** This micro-spec updated (add blocked states to Section 6.2, update Section 6.3)
5. **Audit:** Update audit to capture blocked edit/repricing/resolution attempts
6. **Tests:** Comprehensive tests for blocked mutation scenarios

**Change Control:** Must follow Freeze-Gate process

### Extension C ‚Äî Lock/Unlock Authority + Reason Tracking

**What Could Be Extended:**
- Add `locked_by` (FK to users), `locked_at` (timestamp), `lock_reason` (text) columns
- Implement lock/unlock API endpoints with authorization checks
- Track lock history and reason

**What MUST Happen Before Extension:**
1. **Decision:** Governance approval (authorization model, reason requirements)
2. **Schema:** Migration adding columns
3. **Runtime:** Lock/unlock endpoints + authorization logic
4. **Audit:** Mandatory audit events (LOCK_APPLIED, UNLOCK_APPLIED) with full metadata
5. **Doc Update:** This micro-spec updated (add authority semantics, reason tracking)
6. **Tests:** Comprehensive tests for lock/unlock workflows

**Change Control:** Must follow Freeze-Gate process

### Extension Guardrails

**All extensions must:**
- Maintain core MVP invariant: lock prevents deletion (at minimum)
- Update this micro-spec (documentation is mandatory)
- Not break existing locked items (backward compatibility)
- Preserve audit requirements (traceability is non-negotiable)

‚∏ª

## 1Ô∏è‚É£2Ô∏è‚É£ Freeze-Gate Declaration

- **Status:** üîí LOCKED
- **Effective Date:** 2026-01-27
- **Change Requires:** Phase-5 Senate approval

**Locked Guarantees:**
- Lock scope is line-item only (MVP)
- Lock prevents deletion (service-layer enforcement required)
- Lock does NOT block edits/repricing/resolution (MVP)
- Lock does NOT propagate to parent levels (MVP)
- Future extensions require explicit governance approval

‚∏ª

---

**Micro-Spec Version:** 1.0  
**Based on Template:** Tier-1 Micro-Spec Template v1.0  
**Related Documents:**
- A5.1 (Field coverage review)
- A5.2 (Scope decision ‚Äî primary reference)
- A5.3‚ÄìA5.5 (Absence proofs)
- A5.6 (Checklist/data dictionary closure)
- A7.2 (Deletion & Mutation Guardrails ‚Äî related runtime enforcement)
- G-04 (RateSource consistency ‚Äî related but separate concern)

**Implementation Evidence:**
- `backend/alembic/versions/20260104_110400_create_schema_canon_v1_0_l1_l2_quo_pricing.py` (schema definition, lines 439, 484)
- `docs/PHASE_5/03_DATA_DICTIONARY/LOCKING_POLICY.md` (policy documentation)
- Runtime enforcement: Planned (not yet implemented, per A5.1 findings)

**Schema Verification:**
- **Column:** `quote_bom_items.is_locked` (BOOLEAN, NOT NULL, default false)
- **Index:** `idx_quote_bom_items_is_locked` (non-unique)
- **Absences Verified:** `quote_panels.is_locked`, `quote_boms.is_locked`, `quotations.is_locked` (all absent per A5.3‚ÄìA5.5)

