# v1.3 Model — Phase 5 Placement & Missing Elements

**Date:** 2025-01-XX  
**Status:** CLARIFICATION DOCUMENT  
**Purpose:** Clarify v1.3 belongs to Phase 5 (NSW), identify missing elements, and prepare for Phase 4 closure

---

## 1. v1.3 Model Placement (Phase 5, Not Phase 4)

### ✅ Correct Understanding

**v1.3 belongs to Phase 5 (NSW canonical build), NOT Phase 4 (legacy stabilization).**

### Two Truth Layers Rule (Enforced)

- **Phase 4 (Legacy Truth):**
  - Stabilizes what exists
  - Creates SHARED lookup endpoints (transport layer)
  - Does NOT define NSW meaning
  - Keeps legacy operational

- **Phase 5 (NSW Truth - v1.3):**
  - Defines NSW canonical design
  - Uses v1.3 model as canonical structure
  - New tables/services (clean build)
  - No injection into legacy tables

### ✅ No Conflict

v1.3 does NOT disturb Phase 4 because:
- Phase 4 keeps legacy running
- Phase 5 defines NSW canonical truth separately
- Coexistence policy enforces separation
- No forced mapping or silent reinterpretation

---

## 2. What v1.3 Immediately Provides (High Value)

### Clean Canonical Core
- L1 (BASE+FEATURE) intent structure
- KVU attributes (Key-Value-Unit model)
- Feature policy (vendor variability handling)
- L2 explosion logic (idempotent)
- SKU-only pricing (price truth separation)

### Single Predictable Engine Surface
- `explode_L1→L2` idempotently
- Exactly what was messy in legacy
- Future-proof "one intent → many SKUs" handling

### Connection to Phase 4 (Without Conflict)
- Phase 4 created stability + seams (SHARED endpoints)
- Phase 4 reduced chaos in legacy (transport stabilization)
- Phase 4 did NOT define NSW meaning (that's Phase 5)
- v1.3 will be used as Phase 5 canonical design

---

## 3. Missing Elements in Current v1.3 Workbook

### ⚠️ What's Present (5 Sheets)
1. ✅ GENERIC_MASTER
2. ✅ GENERIC_ATTRIBUTES
3. ✅ ATTRIBUTE_MASTER
4. ✅ FEATURE_MASTER
5. ✅ MAKE_SERIES_FEATURE_POLICY

### ❌ What's Missing (Required for Implementation)

#### 3.1 SKU Master + SKU Price Datasets

**Missing:**
- SKU_MASTER sheet
- SKU_PRICE_HISTORY sheet (versioned)

**Required Structure:**

**SKU_MASTER:**
- SKU_Code (PK)
- Supplier_Part_No
- Make (FK or text)
- Series (FK or text, nullable)
- Description
- Lifecycle_Status (ACTIVE/INACTIVE)
- Created_Date
- Last_Updated

**SKU_PRICE_HISTORY:**
- SKU_Code (FK)
- Rate
- Currency
- EffectiveFrom (DATE)
- EffectiveTo (DATE, nullable)
- PriceListRef
- PriceListVersion (optional)
- Region (default: INDIA)

---

#### 3.2 Item↔SKU Mapping Table

**Missing:**
- ITEM_SKU_MAPPING sheet

**Required Structure:**

**ITEM_SKU_MAPPING:**
- Item_ProductType (FK or text)
- SKU_Code (FK)
- Role (ENUM: BASE/ADDON/OPTIONAL/SERVICE)
- Rule_Expression (nullable, text - condition logic)
- Qty_Formula (nullable, text - quantity calculation)
- Sequence (INTEGER - order of application)
- Mapping_Rule_Id (optional, FK for audit)
- Make (nullable, FK or text - for make-specific mapping)
- Series (nullable, FK or text - for series-specific mapping)

**Purpose:** Engineering-controlled mapping (not catalog-imported). Controls auto-inclusion during BOM generation.

---

#### 3.3 Base SKU Resolver Inputs

**Missing:** Clear specification of where `resolve_base_sku(base_line, make, series)` looks

**Required:**
- Resolution logic must reference:
  - SKU_MASTER (to find candidate SKUs)
  - ITEM_SKU_MAPPING (to find BASE role SKUs for item type)
  - Base attributes matching (from GENERIC_ATTRIBUTES)
  - Make/Series filtering

**Documentation Needed:**
- Base SKU resolution algorithm specification
- Attribute matching rules
- Fallback behavior if no match found

---

#### 3.4 History Tables

**Missing:** History table specifications

**Required Structures:**

**L2_EXPLOSION_HISTORY:**
- Explosion_Id (PK)
- L1_Group_Id (FK)
- Make
- Series
- Trigger_Source (CREATE/CHANGE/VENDOR_CHANGE/CATALOG_REFRESH)
- Triggered_By_User (nullable)
- Triggered_At (TIMESTAMP)
- Before_Snapshot (JSON, nullable)
- After_Snapshot (JSON, nullable)
- Status (SUCCESS/FAILED/PARTIAL)

**L2_LINES_HISTORY:**
- History_Id (PK)
- Explosion_Id (FK to L2_EXPLOSION_HISTORY)
- L2_Line_Id (original line ID)
- Parent_L1_Id (FK)
- SKU_Code (FK)
- Role (BASE/ADDON)
- Qty (at time of snapshot)
- Unit_Price (at time of snapshot)
- Action (CREATED/UPDATED/DELETED)
- Snapshot_At (TIMESTAMP)

**OR Alternative:**
- Single canonical history table with snapshot JSON (simpler but less queryable)

---

## 4. Phase 5 Derived Artifacts Needed

### From v1.3 Workbook, Generate:

#### 4.1 NSW Canonical DB Schema

**Deliverables:**
- Migration files list
- ERD (Entity Relationship Diagram)
- Table definitions with all columns
- FK relationships
- Constraints (PK/FK/Unique/Check)
- Indexes (for performance)

**Tables to Design:**
1. `l1_intent_lines` (from GENERIC_MASTER)
2. `l1_attributes` (from GENERIC_ATTRIBUTES)
3. `attribute_master` (from ATTRIBUTE_MASTER)
4. `feature_master` (from FEATURE_MASTER)
5. `make_series_feature_policy` (from MAKE_SERIES_FEATURE_POLICY)
6. `sku_master` (missing - needs design)
7. `sku_price_history` (missing - needs design)
8. `item_sku_mapping` (missing - needs design)
9. `l1_subcategory_selections` (junction table for multi-SubCategory)
10. `l2_explosion_history` (missing - needs design)
11. `l2_lines_history` (missing - needs design, or combine with above)

---

#### 4.2 CSV Templates

**Templates Needed:**
1. L1 Master Import (GENERIC_MASTER structure)
2. KVU Attributes Import (GENERIC_ATTRIBUTES structure)
3. Feature Policy Import (MAKE_SERIES_FEATURE_POLICY structure)
4. SKU Master Import (missing - needs template)
5. SKU Price History Import (missing - needs template)
6. Item-SKU Mapping Import (missing - needs template)

**Each Template Should Include:**
- Column headers
- Data type specifications
- Validation rules
- Example rows
- Error handling guidance

---

#### 4.3 Service Specifications

**Service Specs Needed:**

1. **Policy Resolver Service:**
   - Input: Item_ProductType, Feature_Code, Make, Series
   - Output: Handling_Type, SKU_Code (if ADDON), Base_Variant_Rule (if BUNDLED)
   - Priority resolution logic (series → make → global)

2. **L2 Explosion Service:**
   - Pseudocode already in Fundamentals v2.0 Section AA.2
   - Needs: Full specification with all edge cases
   - Needs: Error handling specifications
   - Needs: Validation gate specifications

3. **Base SKU Resolver Service:**
   - Input: Base line (L1), Make, Series, Base attributes
   - Output: Base SKU_Code
   - Needs: Resolution algorithm specification
   - Needs: Attribute matching rules
   - Needs: Fallback behavior

4. **Validation Gates Service:**
   - Base SKU missing → HARD BLOCK
   - Feature selected but policy missing → HARD BLOCK
   - ADDON required but SKU missing → HARD BLOCK
   - INCLUDED but base SKU missing → HARD BLOCK
   - L2 orphan lines → INVALID STATE

5. **Audit/History Service:**
   - Snapshot L2 state before/after explosion
   - Log trigger source, actor, timestamp
   - Store history records
   - Query history for audit trails

---

## 5. Will This Disturb Current Work?

### ✅ NO - If We Enforce:

1. **Phase 4: Keep Legacy Stable**
   - Do NOT inject NSW semantics into legacy tables
   - Keep legacy operational as-is
   - Complete S4 batches with evidence

2. **Phase 5: Build NSW Cleanly**
   - New tables/services only
   - No legacy table modifications
   - Only later decide integration/migration (separate project)

### ⚠️ Challenge: Team Confusion

**Risk:** People assuming legacy Category/SubCategory/Item = NSW Category/SubCategory/Item

**Mitigation:** Coexistence policy already blocks this - keep it enforced.

**Reference:** `docs/PHASE_5/LEGACY_VS_NSW_COEXISTENCE_POLICY.md`

---

## 6. What to Do Next (Practical)

### A) Finish Phase 4 Closure

**What's Still Pending (in plain terms):**

1. **Complete S4-3 Evidence:**
   - S4-3 CP0 baseline ✅ (done)
   - S4-3 CP1, CP2, CP3 evidence packs (if not complete)

2. **Remaining Lane-A Gaps:**
   - Check GAP_GATEBOARD.md for OPEN/PARTIAL status
   - Either:
     - CLOSED with evidence, OR
     - Explicitly staged to implementation batch
     - Evidence folders prepared

3. **Phase 4 Closure Documentation:**
   - Final task list status
   - Gap closure summary
   - Execution-dependent items documented (with evidence templates)

---

### B) For Phase 5 Readiness

**Use v1.3 to produce three derived artifacts (planning-only, no DB needed):**

1. **NSW Canonical DB Schema**
   - Migrations list + ERD
   - Include missing tables (SKU, mapping, history)

2. **CSV Templates**
   - L1 master, KVU attributes, feature policy
   - SKU master, price history
   - Item-SKU mapping

3. **Service Specs**
   - Policy resolver
   - L2 explosion (enhance pseudocode with missing elements)
   - Base SKU resolver
   - Validation gates
   - Audit/history

---

## 7. Action Items Summary

### Immediate (Phase 4 Closure)
- [ ] Review GAP_GATEBOARD.md for remaining OPEN/PARTIAL gaps
- [ ] Complete S4-3 CP1, CP2, CP3 evidence (if pending)
- [ ] Stage remaining gaps with evidence folders
- [ ] Complete Phase 4 closure documentation

### Next (Phase 5 Planning)
- [ ] Add missing sheets to v1.3 workbook:
  - SKU_MASTER
  - SKU_PRICE_HISTORY
  - ITEM_SKU_MAPPING
- [ ] Design history tables (L2_EXPLOSION_HISTORY, L2_LINES_HISTORY)
- [ ] Generate Phase 5 derived artifacts:
  - DB schema (including missing tables)
  - CSV templates (including missing templates)
  - Service specs (including missing services)

---

## 8. References

- **v1.3 Workbook:** NEPL_NSW_v1.3_FINAL_WORKBOOK.xlsx
- **Master Doctrine:** `MASTER_FUNDAMENTALS_v2.0.md`
- **v1.3 Philosophy:** `v1.3_WORKBOOK_README.md`
- **Phase 4 Status:** `docs/PHASE_4/GAP_GATEBOARD.md`, `docs/PHASE_4/MASTER_TASK_LIST.md`
- **Phase 5 Scope:** `docs/PHASE_5/PHASE_5_SCOPE_FENCE.md`
- **Coexistence Policy:** `docs/PHASE_5/LEGACY_VS_NSW_COEXISTENCE_POLICY.md`
- **Master Data Governance:** `docs/PHASE_5/ADR-005_MASTER_DATA_GOVERNANCE_FIREWALL.md`

---

**Document Status:** ✅ COMPLETE  
**Next Step:** Phase 4 closure checklist created - see `docs/PHASE_4/PHASE_4_CLOSURE_CHECKLIST.md`

