name: Gates (Full RAG)

on:
  pull_request:
  workflow_dispatch:

jobs:
  gates:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install curl
        run: sudo apt-get update && sudo apt-get install -y curl

      - name: AppleDouble hygiene (CI)
        shell: bash
        run: |
          echo "Checking for tracked AppleDouble files (._*) only..."
          offenders=$(git ls-files | grep '/\._' || true)
          if [ -n "$offenders" ]; then
            echo "AppleDouble files found in repo:"
            echo "$offenders"
            exit 1
          else
            echo "No AppleDouble files found."
          fi

      - name: Regenerate Decision KB manifest (phase5_pack/00_INDEX.json)
        run: |
          python3 - <<'PY'
          import json
          from pathlib import Path

          root = Path("RAG_KB/decisions/phase5_pack")
          rules_dir = root / "04_RULES_LIBRARY"

          if not rules_dir.exists():
              print("Decision KB not present â€” skipping Decision RAG indexing.")
              (root).mkdir(parents=True, exist_ok=True)
              (root / "00_INDEX.json").write_text(json.dumps({
                  "kb_version": "0.0",
                  "index_version": "0.0",
                  "files": []
              }, indent=2))
              raise SystemExit(0)

          files = sorted([p for p in rules_dir.rglob("*.md") if not p.name.startswith("._")])
          manifest = {
              "kb_version": "1.0",
              "index_version": "1.0",
              "files": [str(p.relative_to(root)).replace("\\", "/") for p in files],
          }
          (root / "00_INDEX.json").write_text(json.dumps(manifest, indent=2))
          print(f"Wrote Decision manifest with {len(files)} files")
          PY

      - name: Run Working RAG indexer
        run: |
          docker compose -f docker-compose.rag.yml --profile index up --build --abort-on-container-exit
          docker compose -f docker-compose.rag.yml --profile index down --remove-orphans || true

      - name: Start Working RAG query
        run: |
          docker compose -f docker-compose.rag.yml --profile rag up -d --build
          for i in {1..30}; do
            if curl -fsS http://localhost:8011/health >/dev/null; then
              echo "Working RAG healthy"
              exit 0
            fi
            sleep 2
          done
          echo "Working RAG did not become healthy"
          exit 1

      - name: Run Decision RAG indexer
        run: |
          docker compose -f docker-compose.rag.decisions.yml --profile decisions_index up --build --abort-on-container-exit
          docker compose -f docker-compose.rag.decisions.yml --profile decisions_index down --remove-orphans || true

      - name: Start Decision RAG query
        run: |
          docker compose -f docker-compose.rag.decisions.yml --profile decisions_rag up -d --build
          for i in {1..30}; do
            if curl -fsS http://localhost:8021/health >/dev/null; then
              echo "Decision RAG healthy"
              exit 0
            fi
            sleep 2
          done
          echo "Decision RAG did not become healthy"
          exit 1

      - name: Run gates (make gates)
        run: |
          chmod +x tools/gates/run_gates.sh
          if [ -f Makefile ] && grep -qE '^[[:space:]]*gates:' Makefile; then
            make gates
          else
            tools/gates/run_gates.sh
          fi

      - name: Upload gate reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-reports
          path: governance/decisions/staging/gate_run_*.md

      - name: Cleanup docker
        if: always()
        run: |
          docker compose -f docker-compose.rag.yml down --remove-orphans || true
          docker compose -f docker-compose.rag.decisions.yml down --remove-orphans || true
