name: quality-gates

on:
  pull_request:
  push:
    branches: [ main, develop ]

jobs:
  python-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install lint tools
        run: python -m pip install --upgrade pip ruff black
      - name: Ruff + Black (changed files)
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.base_ref }}"
            git fetch origin "${BASE_REF}" --depth=1
            CHANGED=$(git diff --name-only "origin/${BASE_REF}"...HEAD | grep -E '\.py$' || true)
          else
            CHANGED=$(git diff --name-only HEAD~1..HEAD | grep -E '\.py$' || true)
          fi
          if [ -z "$CHANGED" ]; then
            echo "No Python changes to lint."
            exit 0
          fi
          echo "Linting: $CHANGED"
          ruff check $CHANGED
          black --check $CHANGED

  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps + mypy
        run: |
          python -m pip install --upgrade pip
          if [ -f backend/requirements.txt ]; then
            pip install -r backend/requirements.txt
          fi
          pip install mypy
      - name: Mypy (backend)
        run: |
          if [ -d backend/app ]; then
            mypy \
              backend/app/core \
              backend/app/estimation \
              backend/app/validators \
              backend/app/models \
              backend/app/api/v1/schemas \
              --ignore-missing-imports --follow-imports=skip
          else
            echo "backend/app not found; skipping mypy."
          fi

  backend-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps + pytest
        run: |
          python -m pip install --upgrade pip
          if [ -f backend/requirements.txt ]; then
            pip install -r backend/requirements.txt
          fi
          pip install pytest pytest-cov
      - name: Pytest (phase5)
        run: |
          if [ -d backend/tests/phase5 ]; then
            PYTHONPATH=backend pytest -q backend/tests/phase5 \
              --cov=backend/app \
              --cov-report=xml:backend/coverage.xml
          else
            echo "backend/tests/phase5 not found; skipping pytest."
          fi
      - name: Generate coverage badge (main only)
        if: github.ref == 'refs/heads/main'
        run: |
          python -m pip install 'genbadge[coverage]'
          mkdir -p docs/badges
          genbadge coverage \
            -i backend/coverage.xml \
            -o docs/badges/coverage.svg
      - name: Create coverage badge PR (main only)
        if: github.ref == 'refs/heads/main'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(badge): update coverage.svg [skip ci]"
          title: "chore(badge): update coverage.svg"
          body: "Automated coverage badge update."
          branch: "bot/coverage-badge-${{ github.run_id }}"
          base: "main"
          add-paths: |
            docs/badges/coverage.svg

  frontend-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "18"
      - name: Install + build (frontend)
        run: |
          if [ -f frontend/package.json ]; then
            cd frontend
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi
            npm run build
          else
            echo "frontend/package.json not found; skipping build."
          fi
