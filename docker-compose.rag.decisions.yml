services:
  decisions_indexer:
    build:
      context: .
      dockerfile: services/kb_indexer/Dockerfile
      args:
        RAG_MODE: ${RAG_MODE:-FULL}
    container_name: nsw_decisions_indexer
    volumes:
      # Mount decisions as phase5_pack so indexer can find it
      - ./RAG_KB/decisions/phase5_pack:/app/RAG_KB/phase5_pack:ro
      - ./RAG_INDEX/decisions:/app/RAG_INDEX
    working_dir: /app
    command: python3 services/kb_indexer/indexer.py --rebuild --verbose
    networks:
      - nsw_network
    profiles:
      - decisions_index

  decisions_query:
    build:
      context: .
      dockerfile: services/kb_query/Dockerfile
      args:
        RAG_MODE: ${RAG_MODE:-FULL}
    container_name: nsw_decisions_query
    ports:
      - "${DECISION_RAG_HOST_PORT:-8021}:8099"
    volumes:
      - ./RAG_INDEX/decisions:/app/RAG_INDEX:ro
    working_dir: /app
    command: python3 services/kb_query/query_server.py --port 8099 --host 0.0.0.0
    environment:
      - PYTHONUNBUFFERED=1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8099/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - nsw_network
    profiles:
      - decisions_rag

networks:
  nsw_network:
    driver: bridge
