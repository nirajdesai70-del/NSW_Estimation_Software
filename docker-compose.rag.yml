services:
  kb_indexer:
    build:
      context: .
      dockerfile: services/kb_indexer/Dockerfile
      args:
        RAG_MODE: ${RAG_MODE:-FULL}
    container_name: nsw_kb_indexer
    volumes:
      - ./RAG_KB:/app/RAG_KB:ro
      - ./RAG_INDEX:/app/RAG_INDEX
    working_dir: /app
    command: python3 services/kb_indexer/indexer.py --rebuild --verbose
    networks:
      - nsw_network
    profiles:
      - index

  kb_query:
    build:
      context: .
      dockerfile: services/kb_query/Dockerfile
      args:
        RAG_MODE: ${RAG_MODE:-FULL}
    container_name: nsw_kb_query
    ports:
      - "${KB_QUERY_HOST_PORT:-8011}:8099"
    volumes:
      - ./RAG_INDEX:/app/RAG_INDEX:ro
    working_dir: /app
    command: python3 services/kb_query/query_server.py --port 8099 --host 0.0.0.0
    environment:
      - PYTHONUNBUFFERED=1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8099/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - nsw_network
    profiles:
      - rag

networks:
  nsw_network:
    driver: bridge

